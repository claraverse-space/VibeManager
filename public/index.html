<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>VibeManager</title>
  <link rel="icon" type="image/x-icon" href="https://claraverse.app/favicon.ico">
  <link rel="stylesheet" href="https://api.fontshare.com/v2/css?f[]=satoshi@400,500,700&display=swap">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #09090b;
      --surface: #111113;
      --surface2: #1a1a1f;
      --surface3: #242429;
      --accent: #6366f1;
      --accent-dim: rgba(99, 102, 241, 0.12);
      --text: #ececf1;
      --text-dim: #63636e;
      --danger: #ef4444;
      --success: #22c55e;
      --warn: #f59e0b;
      --radius: 0px;
    }

    [data-theme="light"] {
      --bg: #f8f8fa;
      --surface: #ffffff;
      --surface2: #f0f0f3;
      --surface3: #e4e4e9;
      --accent: #4f46e5;
      --accent-dim: rgba(79, 70, 229, 0.08);
      --text: #1a1a2e;
      --text-dim: #71717a;
      --danger: #dc2626;
      --success: #16a34a;
      --warn: #d97706;
    }

    body {
      font-family: 'Satoshi', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      height: 100dvh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      touch-action: manipulation;
    }

    /* Toolbar */
    .toolbar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--surface);
      flex-shrink: 0;
    }

    .toolbar button {
      background: var(--surface2);
      color: var(--text);
      border: none;
      padding: 7px 14px;
      border-radius: 0;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      white-space: nowrap;
      -webkit-tap-highlight-color: transparent;
      transition: background 0.15s, transform 0.1s;
    }

    .toolbar button:hover { background: var(--accent-glow); }
    .toolbar button:active { transform: scale(0.96); }
    .toolbar button.active-session-btn {
      background: var(--accent);
      color: #fff;
    }

    .session-name {
      flex: 1;
      font-size: 12px;
      color: var(--text-dim);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      min-width: 40px;
      font-family: monospace;
    }

    .ports-section {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .port-btn {
      background: var(--surface2) !important;
      font-size: 11px !important;
      padding: 4px 9px !important;
      border-radius: 0 !important;
      font-weight: 600 !important;
      font-family: monospace !important;
    }

    .port-btn.active {
      background: var(--accent) !important;
      color: #fff !important;
    }

    /* Session switcher */
    .session-switcher {
      display: flex;
      align-items: center;
      gap: 4px;
      overflow-x: auto;
      scrollbar-width: none;
      -webkit-overflow-scrolling: touch;
      max-width: 40%;
      flex-shrink: 1;
    }

    .session-switcher::-webkit-scrollbar { display: none; }

    .session-switcher:empty { display: none; }

    .ss-btn {
      background: var(--surface2);
      color: var(--text-dim);
      border: none;
      padding: 4px 8px;
      border-radius: 0;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: all 0.12s;
      -webkit-tap-highlight-color: transparent;
      max-width: 120px;
      overflow: hidden;
    }

    .ss-btn:active { transform: scale(0.94); }
    .ss-btn:hover { background: var(--surface3); }

    .ss-btn.active {
      background: var(--accent);
      color: #fff;
    }

    .ss-btn.dead {
      opacity: 0.4;
    }

    .ss-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      flex-shrink: 0;
      background: var(--text-dim);
    }

    .ss-btn.active .ss-dot { background: var(--success); }
    .ss-btn.dead .ss-dot { background: var(--danger); }

    .ss-name {
      overflow: hidden;
      text-overflow: ellipsis;
    }

    @media (max-width: 600px) {
      .session-switcher { max-width: 35%; }
      .ss-btn { padding: 4px 6px; font-size: 10px; max-width: 80px; }
      .ss-name { display: none; }
      .ss-btn::after {
        content: attr(data-index);
        font-size: 10px;
      }
    }

    /* View tabs */
    .view-tabs {
      display: flex;
      gap: 2px;
      padding: 4px 12px;
      background: var(--surface);
      flex-shrink: 0;
    }

    .view-tab {
      flex: 1;
      padding: 6px 12px;
      text-align: center;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      cursor: pointer;
      border: none;
      background: transparent;
      color: var(--text-dim);
      border-radius: 0;
      -webkit-tap-highlight-color: transparent;
      transition: all 0.2s;
    }

    .view-tab.active { color: var(--text); background: var(--surface2); }
    .view-tab:hover:not(.active) { color: var(--text); }

    /* Main content */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Preview */
    .preview-container {
      flex: 1;
      position: relative;
      background: var(--bg);
      min-height: 0;
      min-width: 0;
      display: flex;
      flex-direction: column;
    }

    .preview-container iframe { width: 100%; flex: 1; border: none; min-height: 0; }

    /* Code Editor */
    .code-container {
      flex: 1;
      position: relative;
      background: var(--bg);
      min-height: 0;
      min-width: 0;
      display: flex;
      flex-direction: column;
    }

    .code-container iframe { width: 100%; flex: 1; border: none; min-height: 0; }

    .code-placeholder {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 8px;
      height: 100%;
      color: var(--text-dim);
      font-size: 13px;
    }

    .code-placeholder .icon {
      font-size: 40px;
      opacity: 0.3;
    }

    .code-placeholder .sub {
      font-size: 11px;
      opacity: 0.6;
    }

    .preview-placeholder {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-dim);
      font-size: 13px;
      flex-direction: column;
      gap: 10px;
      padding: 20px;
      text-align: center;
    }

    .preview-placeholder .icon { font-size: 32px; opacity: 0.2; }
    .preview-placeholder .sub { font-size: 11px; opacity: 0.5; }

    .preview-url-bar {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      background: var(--surface);
      flex-shrink: 0;
    }

    .preview-url-bar input {
      flex: 1;
      background: var(--bg);
      border: none;
      color: var(--text);
      padding: 5px 10px;
      border-radius: 0;
      font-size: 12px;
      font-family: monospace;
      outline: none;
      min-width: 0;
    }

    .preview-url-bar input:focus { box-shadow: 0 0 0 1px var(--accent-glow); }
    .preview-url-bar input::placeholder { color: var(--text-dim); }

    .preview-url-bar button {
      background: var(--surface2);
      color: var(--text-dim);
      border: none;
      padding: 5px 8px;
      border-radius: 0;
      cursor: pointer;
      font-size: 13px;
      flex-shrink: 0;
    }

    .preview-url-bar button:hover { background: var(--accent); color: #fff; }

    .preview-toolbar {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      gap: 4px;
      z-index: 10;
      opacity: 0.4;
      transition: opacity 0.2s;
    }

    .preview-container:hover .preview-toolbar { opacity: 1; }

    .preview-toolbar button {
      background: var(--surface);
      color: var(--text-dim);
      border: none;
      padding: 5px 9px;
      border-radius: 0;
      cursor: pointer;
      font-size: 14px;
    }

    .preview-toolbar button:hover { background: var(--accent); color: #fff; }

    /* Resizer */
    .resizer {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      transition: background 0.15s;
    }

    /* Vertical resizer (mobile split) */
    .resizer.vertical {
      height: 8px;
      cursor: row-resize;
    }

    .resizer.vertical::after {
      content: '';
      width: 32px;
      height: 3px;
      border-radius: 0;
      background: var(--surface2);
      transition: background 0.15s;
    }

    /* Horizontal resizer (desktop split) */
    .resizer.horizontal {
      width: 8px;
      cursor: col-resize;
    }

    .resizer.horizontal::after {
      content: '';
      width: 3px;
      height: 32px;
      border-radius: 0;
      background: var(--surface2);
      transition: background 0.15s;
    }

    .resizer:hover::after { background: var(--accent); }

    /* Virtual keys */
    .virtual-keys {
      display: flex;
      gap: 4px;
      padding: 5px 8px;
      background: var(--surface);
      flex-shrink: 0;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }

    .virtual-keys::-webkit-scrollbar { display: none; }

    .vkey {
      background: var(--surface2);
      color: var(--text-dim);
      border: none;
      padding: 5px 10px;
      border-radius: 0;
      font-size: 11px;
      font-family: monospace;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      flex-shrink: 0;
      transition: all 0.12s;
    }

    .vkey:active { background: var(--accent); color: #fff; transform: scale(0.93); }
    .vkey.sticky.active { background: var(--danger); color: #fff; }

    /* Terminal */
    .terminal-container {
      position: relative;
      min-height: 0;
      min-width: 0;
      background: var(--bg);
      display: flex;
      flex-direction: column;
    }

    .terminal-container .xterm { flex: 1; padding: 4px 2px; min-height: 0; }

    /* Connecting overlay */
    .connect-overlay {
      position: absolute;
      inset: 0;
      background: var(--bg);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10;
      font-family: 'JetBrains Mono', 'Fira Code', monospace;
    }
    .connect-overlay.visible { display: flex; }
    .connect-overlay .co-text {
      color: var(--accent);
      font-size: 13px;
      margin-bottom: 12px;
    }
    .connect-overlay .co-spinner {
      display: flex;
      gap: 3px;
    }
    .connect-overlay .co-spinner span {
      width: 6px;
      height: 16px;
      background: var(--accent);
      opacity: 0.2;
      animation: co-pulse 0.8s ease-in-out infinite;
    }
    .connect-overlay .co-spinner span:nth-child(2) { animation-delay: 0.1s; }
    .connect-overlay .co-spinner span:nth-child(3) { animation-delay: 0.2s; }
    .connect-overlay .co-spinner span:nth-child(4) { animation-delay: 0.3s; }
    .connect-overlay .co-spinner span:nth-child(5) { animation-delay: 0.4s; }
    .connect-overlay .co-spinner span:nth-child(6) { animation-delay: 0.5s; }
    .connect-overlay .co-spinner span:nth-child(7) { animation-delay: 0.6s; }
    .connect-overlay .co-spinner span:nth-child(8) { animation-delay: 0.7s; }
    @keyframes co-pulse {
      0%, 100% { opacity: 0.2; transform: scaleY(0.6); }
      50% { opacity: 1; transform: scaleY(1); }
    }
    .connect-overlay .co-session {
      color: var(--text-dim);
      font-size: 11px;
      margin-top: 10px;
    }

    /* Logo */
    .toolbar-logo {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-right: 4px;
    }
    .toolbar-logo img {
      width: 22px;
      height: 22px;
      border-radius: 50%;
    }
    .toolbar-logo .logo-text {
      font-size: 13px;
      font-weight: 700;
      color: var(--text);
      letter-spacing: -0.3px;
    }

    /* View modes */
    .main-content[data-view="preview"] .terminal-container,
    .main-content[data-view="preview"] .code-container,
    .main-content[data-view="preview"] .resizer { display: none; }
    .main-content[data-view="preview"] .preview-container { flex: 1; width: 100%; height: 100%; }

    .main-content[data-view="code"] .terminal-container,
    .main-content[data-view="code"] .preview-container,
    .main-content[data-view="code"] .resizer { display: none; }
    .main-content[data-view="code"] .code-container { flex: 1; width: 100%; height: 100%; }

    .main-content[data-view="terminal"] .preview-container,
    .main-content[data-view="terminal"] .code-container,
    .main-content[data-view="terminal"] .resizer { display: none; }
    .main-content[data-view="terminal"] .terminal-container { width: 100%; height: 100%; flex: 1; }

    /* Split: desktop = side by side, mobile = stacked */
    .main-content[data-view="split"] {
      flex-direction: row;
    }

    .main-content[data-view="split"] .code-container {
      display: none;
    }

    .main-content[data-view="split"] .terminal-container {
      width: 50%;
      height: 100%;
      flex: none;
    }

    .main-content[data-view="split"] .preview-container {
      flex: 1;
      height: 100%;
    }

    .main-content[data-view="split"] .resizer {
      width: 8px;
      height: 100%;
    }

    @media (max-width: 600px) {
      .main-content[data-view="split"] {
        flex-direction: column;
      }

      .main-content[data-view="split"] .terminal-container {
        width: 100%;
        height: 50%;
        flex: none;
      }

      .main-content[data-view="split"] .preview-container {
        width: 100%;
        height: auto;
        flex: 1;
      }

      .main-content[data-view="split"] .resizer {
        width: 100%;
        height: 8px;
      }
    }

    /* Dashboard view mode */
    .main-content[data-view="dashboard"] .terminal-container,
    .main-content[data-view="dashboard"] .preview-container,
    .main-content[data-view="dashboard"] .code-container,
    .main-content[data-view="dashboard"] .resizer { display: none; }
    .main-content[data-view="dashboard"] .dashboard-container { display: flex; }

    .main-content[data-view="terminal"] .dashboard-container,
    .main-content[data-view="preview"] .dashboard-container,
    .main-content[data-view="code"] .dashboard-container,
    .main-content[data-view="split"] .dashboard-container { display: none; }

    /* Dashboard */
    .dashboard-container {
      flex: 1;
      flex-direction: column;
      overflow-y: auto;
      padding: 16px;
      gap: 16px;
      -webkit-overflow-scrolling: touch;
    }

    .dashboard-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .dashboard-header h1 {
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
    }

    .dashboard-header button {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 0;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.15s, transform 0.1s;
    }

    .dashboard-header button:active { transform: scale(0.96); }

    .stats-bar {
      display: flex;
      gap: 16px;
      flex-shrink: 0;
      flex-wrap: wrap;
    }

    .stat-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: var(--surface);
      border-radius: 0;
      flex: 1;
      min-width: 100px;
    }

    .stat-value {
      font-size: 22px;
      font-weight: 700;
      font-family: monospace;
    }

    .stat-label {
      font-size: 11px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-item.running .stat-value { color: var(--success); }
    .stat-item.stopped .stat-value { color: var(--text-dim); }
    .stat-item.total .stat-value { color: var(--accent); }
    .stat-item.uptime .stat-value { color: var(--warn); font-size: 16px; }

    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 12px;
    }

    .session-card {
      background: var(--surface);
      padding: 16px;
      transition: background 0.15s;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .session-card:hover {
      background: var(--surface2);
    }

    .session-card.alive { }
    .session-card.dead { opacity: 0.6; }

    .card-header {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
      background: var(--text-dim);
    }

    .card-dot.alive {
      background: var(--success);
      box-shadow: 0 0 8px rgba(77, 255, 145, 0.4);
      animation: pulse-dot 2s ease-in-out infinite;
    }

    @keyframes pulse-dot {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .card-name {
      font-size: 15px;
      font-weight: 600;
      color: var(--text);
    }

    .card-path {
      font-size: 11px;
      color: var(--text-dim);
      font-family: monospace;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .card-meta {
      font-size: 11px;
      color: var(--text-dim);
      display: flex;
      gap: 12px;
    }

    .card-actions {
      display: flex;
      gap: 8px;
      margin-top: auto;
    }

    .card-actions button {
      flex: 1;
      padding: 7px 12px;
      border: none;
      border-radius: 0;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.12s;
    }

    .card-actions button:active { transform: scale(0.95); }

    .btn-attach {
      background: var(--accent);
      color: #fff;
    }

    .btn-stop {
      background: var(--surface2);
      color: var(--text-dim);
    }

    .btn-stop:hover { background: var(--danger); color: #fff; }

    .btn-revive {
      background: var(--surface2);
      color: var(--success);
    }

    .btn-revive:hover { background: rgba(77, 255, 145, 0.15); }

    .btn-delete {
      background: var(--surface2);
      color: var(--text-dim);
    }

    .btn-delete:hover { background: var(--danger); color: #fff; }

    .btn-timeline {
      background: var(--surface2) !important;
      color: var(--text-dim) !important;
      flex: 0 !important;
      padding: 7px 10px !important;
    }
    .btn-timeline:hover { background: var(--accent) !important; color: #fff !important; }

    .btn-tasks {
      background: var(--surface2) !important;
      color: var(--text-dim) !important;
      flex: 0 !important;
      padding: 7px 10px !important;
    }
    .btn-tasks:hover { background: var(--success) !important; color: #fff !important; }

    /* Task progress in cards */
    .card-tasks {
      margin: 8px 0;
      padding: 8px;
      background: var(--surface);
      border-radius: 0;
    }

    .card-tasks.ralph-running { border-left: 3px solid var(--accent); }
    .card-tasks.ralph-stuck { border-left: 3px solid var(--danger); }
    .card-tasks.ralph-complete { border-left: 3px solid var(--success); }

    .task-progress {
      height: 4px;
      background: var(--surface2);
      border-radius: 0;
      overflow: hidden;
      margin-bottom: 6px;
    }

    .task-bar {
      height: 100%;
      background: var(--accent);
      transition: width 0.3s;
    }

    .ralph-complete .task-bar { background: var(--success); }
    .ralph-stuck .task-bar { background: var(--danger); }

    .task-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: var(--text-dim);
    }

    .ralph-status {
      font-weight: 600;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 0;
    }

    .ralph-running .ralph-status { background: var(--accent-dim); color: var(--accent); }
    .ralph-stuck .ralph-status { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
    .ralph-complete .ralph-status { background: rgba(34, 197, 94, 0.15); color: var(--success); }

    .task-current {
      font-size: 11px;
      color: var(--text);
      margin-top: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .card-summary {
      font-size: 11px;
      color: var(--text-dim);
      margin: 6px 0;
      line-height: 1.4;
      opacity: 0.8;
    }

    .session-card.stuck {
      border-left: 3px solid var(--danger);
    }

    .dashboard-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 60px 20px;
      color: var(--text-dim);
      text-align: center;
    }

    .dashboard-empty .icon { font-size: 40px; opacity: 0.3; }
    .dashboard-empty p { font-size: 14px; }

    @media (max-width: 600px) {
      .dashboard-container { padding: 12px; gap: 12px; }
      .stats-bar { gap: 8px; }
      .stat-item { padding: 8px 12px; min-width: 80px; }
      .stat-value { font-size: 18px; }
      .cards-grid { grid-template-columns: 1fr; }
      .dashboard-header h1 { font-size: 15px; }
      .sysmon { padding: 12px; }
      .sysmon-grid { grid-template-columns: 1fr; }
    }

    /* System Monitor */
    .sysmon {
      background: var(--surface);
      border-radius: 0;
      padding: 16px;
      flex-shrink: 0;
      margin-top: auto;
    }

    .sysmon-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-dim);
      margin-bottom: 12px;
    }

    .sysmon-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
    }

    .sysmon-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .sysmon-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: var(--text-dim);
    }

    .sysmon-value {
      font-family: monospace;
      font-size: 12px;
      font-weight: 600;
      color: var(--text);
    }

    .sysmon-bar {
      height: 14px;
      font-family: monospace;
      font-size: 12px;
      line-height: 14px;
      letter-spacing: -0.5px;
      overflow: hidden;
      white-space: nowrap;
    }

    .sysmon-bar .filled { color: var(--accent); }
    .sysmon-bar .empty { color: var(--surface2); }
    .sysmon-bar.hot .filled { color: var(--danger); }
    .sysmon-bar.warm .filled { color: var(--warn); }
    .sysmon-bar.cool .filled { color: var(--success); }

    .sysmon-sparkline {
      font-family: monospace;
      font-size: 11px;
      line-height: 14px;
      letter-spacing: -1px;
      color: var(--accent);
      height: 14px;
      overflow: hidden;
      white-space: nowrap;
      opacity: 0.8;
    }

    .sysmon-temp {
      font-family: monospace;
      font-size: 20px;
      font-weight: 700;
    }

    .sysmon-temp.cool { color: var(--success); }
    .sysmon-temp.warm { color: var(--warn); }
    .sysmon-temp.hot { color: var(--danger); }

    .sysmon-load {
      font-family: monospace;
      font-size: 12px;
      color: var(--text);
      display: flex;
      gap: 10px;
    }

    .sysmon-net {
      font-family: monospace;
      font-size: 11px;
      color: var(--text-dim);
      display: flex;
      gap: 12px;
    }

    .sysmon-net .rx { color: var(--success); }
    .sysmon-net .tx { color: var(--accent); }

    /* GPU Panel */
    .gpu-panel {
      background: var(--surface);
      border-radius: 0;
      flex-shrink: 0;
      margin-top: 16px;
      overflow: hidden;
    }

    .gpu-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
    }

    .gpu-header:hover {
      background: var(--surface2);
    }

    .gpu-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-dim);
    }

    .gpu-count {
      font-size: 10px;
      padding: 2px 6px;
      background: var(--surface3);
      border-radius: 3px;
      color: var(--text);
    }

    .gpu-toggle {
      font-size: 12px;
      color: var(--text-dim);
      transition: transform 0.3s;
    }

    .gpu-panel.collapsed .gpu-toggle {
      transform: rotate(-90deg);
    }

    .gpu-content {
      max-height: 1000px;
      opacity: 1;
      transition: max-height 0.3s ease, opacity 0.3s ease, padding 0.3s ease;
      padding: 0 16px 16px 16px;
    }

    .gpu-panel.collapsed .gpu-content {
      max-height: 0;
      opacity: 0;
      padding: 0 16px;
      overflow: hidden;
    }

    .gpu-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }

    .gpu-card {
      background: var(--surface2);
      border-radius: 8px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .gpu-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .gpu-card-vendor {
      font-weight: 600;
      font-size: 12px;
      color: var(--text);
    }

    .gpu-card-name {
      font-size: 10px;
      color: var(--text-dim);
    }

    .gpu-metrics {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .gpu-metric {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .gpu-metric-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 10px;
      color: var(--text-dim);
    }

    .gpu-metric-value {
      font-family: monospace;
      font-size: 11px;
      font-weight: 600;
      color: var(--text);
      transition: color 0.3s;
    }

    .gpu-metric-bar {
      height: 4px;
      background: var(--surface3);
      border-radius: 2px;
      overflow: hidden;
      position: relative;
    }

    .gpu-metric-bar-fill {
      height: 100%;
      transition: width 0.5s ease, background-color 0.3s;
      border-radius: 2px;
    }

    .gpu-metric-bar-fill.cool { background: var(--success); }
    .gpu-metric-bar-fill.warm { background: var(--warn); }
    .gpu-metric-bar-fill.hot { background: var(--danger); }

    .gpu-metric-subtext {
      font-size: 9px;
      color: var(--text-dim);
      opacity: 0.7;
    }

    @media (max-width: 600px) {
      .gpu-metrics { grid-template-columns: 1fr; }
    }

    /* Memory Panel */
    .memory-panel {
      background: var(--surface);
      border-radius: 0;
      padding: 16px;
      flex-shrink: 0;
      margin-top: 16px;
    }

    .memory-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .memory-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-dim);
    }

    .memory-actions {
      display: flex;
      gap: 8px;
    }

    .memory-actions button {
      background: var(--surface2);
      border: none;
      color: var(--text-dim);
      font-size: 10px;
      padding: 4px 8px;
      cursor: pointer;
    }

    .memory-actions button:hover {
      background: var(--accent);
      color: #fff;
    }

    .memory-stats {
      display: flex;
      gap: 16px;
      margin-bottom: 12px;
      font-size: 11px;
      color: var(--text-dim);
    }

    .memory-stat {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .memory-stat-value {
      font-weight: 600;
      color: var(--text);
    }

    .memory-entries {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 200px;
      overflow-y: auto;
    }

    .memory-entry {
      background: var(--surface2);
      padding: 10px 12px;
      font-size: 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .memory-entry-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .memory-entry-type {
      font-size: 9px;
      font-weight: 600;
      text-transform: uppercase;
      padding: 2px 6px;
      background: var(--accent-dim);
      color: var(--accent);
    }

    .memory-entry-type.error {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
    }

    .memory-entry-type.preference {
      background: rgba(34, 197, 94, 0.1);
      color: var(--success);
    }

    .memory-entry-type.pattern {
      background: rgba(245, 158, 11, 0.1);
      color: var(--warn);
    }

    .memory-entry-source {
      font-size: 10px;
      color: var(--text-dim);
    }

    .memory-entry-content {
      color: var(--text);
      line-height: 1.4;
    }

    .memory-entry-tags {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      margin-top: 4px;
    }

    .memory-tag {
      font-size: 9px;
      padding: 2px 6px;
      background: var(--surface3);
      color: var(--text-dim);
    }

    .memory-empty {
      text-align: center;
      padding: 20px;
      color: var(--text-dim);
      font-size: 12px;
    }

    .memory-tech-prefs {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .tech-pref-tag {
      font-size: 10px;
      padding: 4px 8px;
      background: var(--accent-dim);
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .tech-pref-count {
      font-weight: 600;
    }

    /* Tasks Modal */
    .tasks-modal-body {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .tasks-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--surface3);
    }

    .tasks-stats {
      display: flex;
      gap: 16px;
      font-size: 12px;
    }

    .tasks-stat {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .tasks-stat-value {
      font-weight: 600;
      color: var(--accent);
    }

    .ralph-controls {
      display: flex;
      gap: 8px;
    }

    .ralph-controls button {
      padding: 6px 12px;
      font-size: 11px;
      border: none;
      cursor: pointer;
    }

    .ralph-controls .btn-start {
      background: var(--success);
      color: #fff;
    }

    .ralph-controls .btn-stop {
      background: var(--danger);
      color: #fff;
    }

    .ralph-controls .btn-pause {
      background: var(--warn);
      color: #fff;
    }

    .ralph-status-badge {
      padding: 4px 10px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .ralph-status-badge.running {
      background: rgba(34, 197, 94, 0.2);
      color: var(--success);
    }

    .ralph-status-badge.paused {
      background: rgba(245, 158, 11, 0.2);
      color: var(--warn);
    }

    .ralph-status-badge.complete {
      background: rgba(99, 102, 241, 0.2);
      color: var(--accent);
    }

    .ralph-status-badge.stuck {
      background: rgba(239, 68, 68, 0.2);
      color: var(--danger);
    }

    .ralph-status-badge.idle {
      background: var(--surface3);
      color: var(--text-dim);
    }

    .task-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 300px;
      overflow-y: auto;
    }

    .task-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 12px;
      background: var(--surface2);
    }

    .task-checkbox {
      width: 18px;
      height: 18px;
      border: 2px solid var(--surface3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      flex-shrink: 0;
      margin-top: 2px;
    }

    .task-item.completed .task-checkbox {
      background: var(--success);
      border-color: var(--success);
      color: #fff;
    }

    .task-item.current .task-checkbox {
      border-color: var(--accent);
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4); }
      50% { box-shadow: 0 0 0 6px rgba(99, 102, 241, 0); }
    }

    .task-content {
      flex: 1;
    }

    .task-title {
      font-weight: 500;
      margin-bottom: 4px;
    }

    .task-item.completed .task-title {
      text-decoration: line-through;
      opacity: 0.6;
    }

    .task-description {
      font-size: 11px;
      color: var(--text-dim);
      line-height: 1.4;
    }

    /* Progress bar */
    .task-progress-bar {
      width: 100%;
      height: 4px;
      background: var(--surface3);
      margin-top: 8px;
      margin-bottom: 6px;
      overflow: hidden;
      position: relative;
    }

    .task-progress-fill {
      height: 100%;
      background: var(--accent);
      transition: width 0.5s ease;
    }

    .task-item.completed .task-progress-fill {
      background: var(--success);
    }

    .task-progress-text {
      font-size: 10px;
      color: var(--text-dim);
      margin-top: 4px;
    }

    /* Step indicators */
    .task-steps {
      display: flex;
      gap: 6px;
      margin-top: 6px;
      flex-wrap: wrap;
    }

    .task-step {
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 0;
      background: var(--surface3);
      color: var(--text-dim);
      display: flex;
      align-items: center;
      gap: 3px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .task-step.completed {
      background: rgba(34, 197, 94, 0.15);
      color: var(--success);
    }

    .task-step.in-progress {
      background: rgba(99, 102, 241, 0.15);
      color: var(--accent);
      animation: pulse-step 1.5s infinite;
    }

    @keyframes pulse-step {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }

    .task-step.pending {
      background: var(--surface3);
      color: var(--text-dim);
      opacity: 0.5;
    }

    /* Live status indicator */
    .task-live-status {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 9px;
      color: var(--text-dim);
      margin-top: 6px;
    }

    .pulse-dot {
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: var(--success);
      animation: pulse-dot 2s infinite;
    }

    @keyframes pulse-dot {
      0%, 100% { opacity: 0.3; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.2); }
    }

    .task-actions {
      display: flex;
      gap: 4px;
    }

    .task-actions button {
      background: var(--surface3);
      border: none;
      color: var(--text-dim);
      font-size: 10px;
      padding: 4px 8px;
      cursor: pointer;
    }

    .task-actions button:hover {
      background: var(--accent);
      color: #fff;
    }

    .add-task-form {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 12px;
      background: var(--surface2);
    }

    .add-task-form input,
    .add-task-form textarea {
      background: var(--surface);
      border: 1px solid var(--surface3);
      color: var(--text);
      padding: 8px;
      font-size: 12px;
      font-family: inherit;
    }

    .add-task-form textarea {
      resize: vertical;
      min-height: 60px;
    }

    .add-task-form .form-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    .add-task-form button {
      padding: 6px 12px;
      font-size: 11px;
      border: none;
      cursor: pointer;
    }

    .add-task-form .btn-add {
      background: var(--accent);
      color: #fff;
    }

    .add-task-form .btn-cancel {
      background: var(--surface3);
      color: var(--text);
    }

    .no-tasks {
      text-align: center;
      padding: 30px;
      color: var(--text-dim);
    }

    .no-tasks-icon {
      font-size: 32px;
      margin-bottom: 10px;
      opacity: 0.5;
    }

    /* Fullscreen */
    .fullscreen-preview .toolbar,
    .fullscreen-preview .view-tabs,
    .fullscreen-preview .status-bar,
    .fullscreen-preview .resizer,
    .fullscreen-preview .terminal-container { display: none !important; }
    .fullscreen-preview .main-content { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 900; }
    .fullscreen-preview .preview-container { flex: 1; height: 100%; }
    .fullscreen-preview .preview-toolbar { opacity: 1; }

    /* Status bar */
    .status-bar {
      padding: 4px 12px;
      background: var(--surface);
      font-size: 10px;
      color: var(--text-dim);
      display: flex;
      justify-content: space-between;
      flex-shrink: 0;
      font-family: monospace;
    }

    .status-dot {
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      margin-right: 5px;
      background: var(--text-dim);
    }

    .status-dot.connected { background: var(--success); box-shadow: 0 0 6px rgba(77, 255, 145, 0.4); }

    /* Modals */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(4px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .modal-overlay.open { display: flex; }

    .modal {
      background: var(--surface);
      border-radius: 0;
      width: 100%;
      max-width: 480px;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .modal-header {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-header h3 { font-size: 16px; font-weight: 600; }

    .modal-header .close-btn {
      background: none;
      border: none;
      color: var(--text-dim);
      font-size: 20px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 0;
    }

    .modal-header .close-btn:hover { background: var(--surface2); }

    .modal-body { flex: 1; overflow-y: auto; padding: 0 16px 16px; -webkit-overflow-scrolling: touch; }

    .modal-footer {
      padding: 12px 16px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .modal-footer button, .modal-body button.action-btn {
      padding: 9px 20px;
      border-radius: 0;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      -webkit-tap-highlight-color: transparent;
      transition: transform 0.1s;
    }

    .modal-footer button:active { transform: scale(0.96); }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-cancel { background: var(--surface2); color: var(--text-dim); }
    .btn-danger { background: var(--danger); color: #fff; }

    /* Session list */
    .session-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 0;
      cursor: pointer;
      transition: background 0.12s;
      margin-bottom: 4px;
    }

    .session-item:hover { background: var(--surface2); }
    .session-item.active { background: var(--accent-glow); }

    .session-item .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .session-item .dot.alive { background: var(--success); }
    .session-item .dot.dead { background: var(--text-dim); }

    .session-item .info { flex: 1; min-width: 0; }
    .session-item .info .name { font-size: 13px; font-weight: 500; }
    .session-item .info .path { font-size: 11px; color: var(--text-dim); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-family: monospace; }

    .session-item .del-btn {
      background: none;
      border: none;
      color: var(--text-dim);
      font-size: 16px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 0;
      opacity: 0;
      transition: opacity 0.15s;
    }

    .session-item:hover .del-btn { opacity: 1; }
    .session-item .del-btn:hover { color: var(--danger); }

    /* New session form */
    .form-group {
      margin-bottom: 12px;
    }

    .form-group label {
      display: block;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-dim);
      margin-bottom: 6px;
    }

    .form-group input {
      width: 100%;
      background: var(--bg);
      border: none;
      color: var(--text);
      padding: 10px 12px;
      border-radius: 0;
      font-size: 14px;
      outline: none;
    }

    .form-group input:focus { box-shadow: 0 0 0 2px var(--accent-glow); }
    .form-group input::placeholder { color: var(--text-dim); }

    .path-picker {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--bg);
      border-radius: 0;
      padding: 4px 4px 4px 12px;
    }

    .path-picker .path-display {
      flex: 1;
      font-size: 12px;
      font-family: monospace;
      color: var(--text-dim);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .path-picker button {
      background: var(--surface2);
      color: var(--text);
      border: none;
      padding: 6px 12px;
      border-radius: 0;
      font-size: 12px;
      cursor: pointer;
    }

    /* Folder browser (inside new session modal) */
    .folder-browser {
      background: var(--bg);
      border-radius: 0;
      margin-top: 8px;
      max-height: 200px;
      overflow-y: auto;
    }

    .folder-browser-nav {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 10px;
      background: var(--surface2);
    }

    .folder-browser-nav button {
      background: var(--surface2);
      color: var(--text);
      border: none;
      padding: 3px 8px;
      border-radius: 0;
      font-size: 11px;
      cursor: pointer;
    }

    .folder-browser-nav .curr-path {
      flex: 1;
      font-size: 10px;
      font-family: monospace;
      color: var(--text-dim);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .folder-browser .fb-item {
      padding: 7px 10px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      border-radius: 0;
      margin: 2px 4px;
    }

    .folder-browser .fb-item:hover { background: var(--surface2); }
    .folder-browser .fb-item.selected { background: var(--accent-glow); }

    /* New folder inline */
    .new-folder-inline {
      display: flex;
      gap: 4px;
      padding: 6px 8px;
      margin-top: 4px;
    }

    .new-folder-inline input {
      flex: 1;
      background: var(--surface);
      border: none;
      color: var(--text);
      padding: 5px 8px;
      border-radius: 0;
      font-size: 11px;
      outline: none;
    }

    .new-folder-inline button {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 5px 10px;
      border-radius: 0;
      font-size: 11px;
      cursor: pointer;
    }

    .source-tab.active, .tool-tab.active {
      background: var(--accent) !important;
      color: #fff !important;
    }

    #btn-create-session.loading {
      opacity: 0.6;
      pointer-events: none;
    }

    /* Confirmation Modal */
    .confirm-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 20px;
    }

    .confirm-modal.visible { display: flex; }

    /* Timeline styles */
    .timeline-item {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      position: relative;
    }

    .timeline-item:not(:last-child)::before {
      content: '';
      position: absolute;
      left: 14px;
      top: 30px;
      bottom: -16px;
      width: 2px;
      background: var(--surface2);
    }

    .timeline-marker {
      width: 30px;
      height: 30px;
      background: var(--surface);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
      border: 2px solid var(--surface2);
      z-index: 1;
    }

    .timeline-item.checkpoint .timeline-marker {
      border-color: var(--accent);
    }

    .timeline-item.success .timeline-marker {
      border-color: var(--success);
    }

    .timeline-item.error .timeline-marker {
      border-color: var(--danger);
    }

    .timeline-card {
      flex: 1;
      background: var(--surface);
      padding: 12px;
      border-radius: 0;
    }

    .timeline-card.small {
      padding: 8px 12px;
    }

    .timeline-item.checkpoint .timeline-card {
      border-left: 3px solid var(--accent);
    }

    .timeline-time {
      font-size: 11px;
      color: var(--text-dim);
      margin-bottom: 4px;
    }

    .timeline-title {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 6px;
    }

    .timeline-meta {
      font-size: 11px;
      color: var(--text-dim);
      margin-bottom: 4px;
      font-family: monospace;
    }

    .timeline-summary {
      font-size: 12px;
      color: var(--text);
      margin: 8px 0;
      line-height: 1.5;
    }

    .timeline-content {
      font-size: 12px;
      color: var(--text);
    }

    .timeline-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .timeline-actions button {
      padding: 5px 12px;
      font-size: 11px;
      background: var(--surface2);
      color: var(--text);
      border: none;
      border-radius: 0;
      cursor: pointer;
    }

    .timeline-actions button:hover {
      background: var(--accent);
      color: #fff;
    }

    .confirm-content {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      max-width: 400px;
      width: 100%;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    }

    .confirm-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 12px;
    }

    .confirm-message {
      font-size: 13px;
      color: var(--text-dim);
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .confirm-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .confirm-actions button {
      padding: 8px 16px;
      font-size: 13px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-family: 'Satoshi', sans-serif;
      min-width: 70px;
    }

    .confirm-btn-cancel {
      background: var(--surface2);
      color: var(--text);
    }

    .confirm-btn-cancel:hover {
      background: var(--surface);
    }

    .confirm-btn-confirm {
      background: var(--danger);
      color: #fff;
    }

    .confirm-btn-confirm:hover {
      background: #e53e3e;
    }

    /* Mobile */
    @media (max-width: 600px) {
      .toolbar { padding: 6px 8px; gap: 6px; }
      .toolbar button { padding: 6px 10px; font-size: 12px; }
      .toolbar-logo { display: none; }
      .ports-section { display: none; }
      .view-tab { padding: 6px 8px; font-size: 10px; }
      .session-item .del-btn { opacity: 1; }

      .confirm-content {
        padding: 16px;
      }

      .confirm-title {
        font-size: 14px;
      }

      .confirm-message {
        font-size: 12px;
      }

      .confirm-actions button {
        flex: 1;
        padding: 10px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>

  <div class="toolbar">
    <div class="toolbar-logo">
      <img src="https://claraverse.app/favicon.ico" alt="VM">
      <span class="logo-text">VibeManager</span>
    </div>
    <button id="btn-sessions">Sessions</button>
    <div class="session-switcher" id="session-switcher"></div>
    <div class="session-name" id="session-name">No session</div>
    <div class="ports-section">
      <div id="ports-container"><span style="font-size:11px;color:var(--text-dim)">--</span></div>
    </div>
    <button id="btn-refresh-ports">Ports</button>
    <button id="btn-theme" title="Toggle theme" style="font-size:15px;padding:7px 10px">‚óê</button>
  </div>

  <div class="view-tabs">
    <button class="view-tab active" data-view="dashboard">Dashboard</button>
    <button class="view-tab" data-view="terminal">Terminal</button>
    <button class="view-tab" data-view="code">Code</button>
    <button class="view-tab" data-view="preview">Preview</button>
    <button class="view-tab" data-view="split">Split</button>
  </div>

  <div class="main-content" id="main-content" data-view="dashboard">
    <div class="dashboard-container" id="dashboard-container">
      <div class="dashboard-header">
        <h1>Projects</h1>
        <div style="display: flex; gap: 8px;">
          <button onclick="window.location.href='/settings.html'" style="background: #6366f1;">ü§ñ Bot Settings</button>
          <button id="btn-new-from-dash" onclick="openNewSessionModal()">+ New Project</button>
        </div>
      </div>
      <div class="stats-bar" id="stats-bar"></div>
      <div class="cards-grid" id="cards-grid"></div>
      <div class="sysmon" id="sysmon">
        <div class="sysmon-title">System Monitor</div>
        <div class="sysmon-grid" id="sysmon-grid"></div>
      </div>

      <div class="gpu-panel" id="gpu-panel" style="display: none;">
        <div class="gpu-header" onclick="toggleGPUPanel()">
          <div class="gpu-title">
            <span>üéÆ GPU Monitor</span>
            <span class="gpu-count" id="gpu-count"></span>
          </div>
          <div class="gpu-toggle" id="gpu-toggle">‚ñº</div>
        </div>
        <div class="gpu-content" id="gpu-content">
          <div class="gpu-grid" id="gpu-grid"></div>
        </div>
      </div>

      <div class="memory-panel" id="memory-panel">
        <div class="memory-header">
          <div class="memory-title">Cross-Session Memory</div>
          <div class="memory-actions">
            <button onclick="aggregateMemories()" title="Aggregate memories from all sessions">Aggregate</button>
            <button onclick="refreshMemory()" title="Refresh memory display">Refresh</button>
          </div>
        </div>
        <div class="memory-stats" id="memory-stats"></div>
        <div class="memory-entries" id="memory-entries">
          <div class="memory-empty">Loading memories...</div>
        </div>
        <div class="memory-tech-prefs" id="memory-tech-prefs"></div>
      </div>
    </div>

    <div class="terminal-container" id="terminal-container">
      <div class="connect-overlay" id="connect-overlay">
        <div class="co-text" id="co-text">Connecting...</div>
        <div class="co-spinner"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></div>
        <div class="co-session" id="co-session"></div>
      </div>
      <div class="virtual-keys" id="virtual-keys">
        <button class="vkey" data-key="escape">Esc</button>
        <button class="vkey" data-key="tab">Tab</button>
        <button class="vkey sticky" data-key="ctrl" id="vkey-ctrl">Ctrl</button>
        <button class="vkey" data-key="ctrl-c">^C</button>
        <button class="vkey" data-key="ctrl-d">^D</button>
        <button class="vkey" data-key="ctrl-z">^Z</button>
        <button class="vkey" data-key="ctrl-l">^L</button>
        <button class="vkey" data-key="ctrl-a">^A</button>
        <button class="vkey" data-key="ctrl-e">^E</button>
        <button class="vkey" data-key="up">&#9650;</button>
        <button class="vkey" data-key="down">&#9660;</button>
        <button class="vkey" data-key="left">&#9664;</button>
        <button class="vkey" data-key="right">&#9654;</button>
        <button class="vkey" data-key="pipe">|</button>
        <button class="vkey" data-key="amp">&amp;</button>
        <button class="vkey" data-key="tilde">~</button>
        <button class="vkey" data-key="dash">-</button>
        <button class="vkey" data-key="slash">/</button>
        <button class="vkey" data-key="copy" style="margin-left:auto">Copy</button>
        <button class="vkey" data-key="paste">Paste</button>
      </div>
    </div>

    <div class="resizer" id="resizer"></div>

    <div class="preview-container" id="preview-container">
      <div class="preview-url-bar" id="preview-url-bar" style="display:none">
        <input type="text" id="preview-url-input" placeholder="http://hostname:port/path">
        <button id="btn-go-url" title="Go">&#9654;</button>
        <button id="btn-refresh-preview" title="Reload">&#8635;</button>
        <button id="btn-open-external" title="Open in browser">&#8599;</button>
        <button id="btn-fullscreen" title="Fullscreen">&#9974;</button>
      </div>
      <div class="preview-placeholder" id="preview-placeholder">
        <div class="icon">&#9881;</div>
        <div>No preview active</div>
        <div class="sub">Start a dev server and select a port</div>
      </div>
      <iframe id="preview-iframe" style="display:none" sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>
    </div>

    <div class="code-container" id="code-container">
      <div class="code-placeholder" id="code-placeholder">
        <div class="icon">&#x1F4BB;</div>
        <div>No project loaded</div>
        <div class="sub">Connect to a session to edit code</div>
      </div>
      <iframe id="code-iframe" style="display:none" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-downloads allow-modals"></iframe>
    </div>
  </div>

  <div class="status-bar">
    <span id="status-shell">--</span>
    <span><span class="status-dot" id="status-dot"></span><span id="status-connection">Disconnected</span></span>
    <span id="notify-toggle" title="Toggle notification sound" style="cursor:pointer;margin-left:8px;">üîî</span>
  </div>

  <!-- Sessions modal -->
  <div class="modal-overlay" id="sessions-modal">
    <div class="modal">
      <div class="modal-header">
        <h3>Sessions</h3>
        <button class="close-btn" id="sessions-close">&times;</button>
      </div>
      <div class="modal-body" id="sessions-list"></div>
      <div class="modal-footer">
        <button class="btn-primary" id="btn-new-session">+ New Session</button>
      </div>
    </div>
  </div>

  <!-- New session modal -->
  <div class="modal-overlay" id="new-session-modal">
    <div class="modal">
      <div class="modal-header">
        <h3>New Session</h3>
        <button class="close-btn" id="new-session-close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Session Name</label>
          <input type="text" id="input-session-name" placeholder="my-project" autocomplete="off">
        </div>
        <div class="form-group">
          <label>Source</label>
          <div style="display:flex;gap:4px;margin-bottom:10px">
            <button class="btn-cancel source-tab active" data-source="folder" id="src-folder-tab" style="flex:1;padding:6px;font-size:11px;text-align:center">Folder</button>
            <button class="btn-cancel source-tab" data-source="git" id="src-git-tab" style="flex:1;padding:6px;font-size:11px;text-align:center">Git Clone</button>
          </div>
          <div id="source-folder">
            <div class="folder-browser">
              <div class="folder-browser-nav">
                <button id="fb-up">&#8592;</button>
                <span class="curr-path" id="fb-path">/home</span>
              </div>
              <div id="fb-list"></div>
              <div class="new-folder-inline">
                <input type="text" id="fb-new-folder" placeholder="New folder...">
                <button id="fb-create">Create</button>
              </div>
            </div>
          </div>
          <div id="source-git" style="display:none">
            <input type="text" id="input-git-url" placeholder="https://github.com/user/repo.git" style="width:100%;background:var(--bg);border:none;color:var(--text);padding:10px 12px;font-size:13px;outline:none;font-family:monospace" autocomplete="off">
            <div style="font-size:10px;color:var(--text-dim);margin-top:6px;padding:0 2px">Clones into ~/repo-name. Supports any git URL (HTTPS, SSH).</div>
          </div>
        </div>
        <div class="form-group">
          <label>Tool</label>
          <div style="display:flex;gap:4px;margin-bottom:8px">
            <button class="btn-cancel tool-tab active" data-tool="opencode" id="tool-opencode-tab" style="flex:1;padding:6px;font-size:11px;text-align:center">OpenCode</button>
            <button class="btn-cancel tool-tab" data-tool="claude" id="tool-claude-tab" style="flex:1;padding:6px;font-size:11px;text-align:center">Claude</button>
            <button class="btn-cancel tool-tab" data-tool="bash" id="tool-bash-tab" style="flex:1;padding:6px;font-size:11px;text-align:center">Bash</button>
          </div>
          <label id="autonomous-label" style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:12px;color:var(--text-dim);padding:4px 0">
            <input type="checkbox" id="input-autonomous" checked style="accent-color:var(--accent);width:16px;height:16px;cursor:pointer">
            <span>Autonomous mode <span style="font-size:10px;opacity:0.7">(--dangerously-skip-permissions)</span></span>
          </label>
        </div>
        <div class="form-group" id="initial-prompt-group">
          <label>Initial Task <span style="font-weight:400;color:var(--text-dim)">(optional)</span></label>
          <textarea id="input-initial-prompt" placeholder="e.g. Build a REST API with Express and MongoDB..." style="width:100%;background:var(--bg);border:none;color:var(--text);padding:10px 12px;font-size:13px;outline:none;font-family:monospace;resize:vertical;min-height:60px;max-height:150px" autocomplete="off"></textarea>
          <div style="font-size:10px;color:var(--text-dim);margin-top:4px;padding:0 2px">Sent to the AI tool after startup. Leave empty to interact manually.</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" id="new-session-cancel">Cancel</button>
        <button class="btn-primary" id="btn-create-session">Create & Open</button>
      </div>
    </div>
  </div>

  <!-- Confirmation modal -->
  <div class="confirm-modal" id="confirm-modal">
    <div class="confirm-content">
      <div class="confirm-title" id="confirm-title">Confirm Action</div>
      <div class="confirm-message" id="confirm-message">Are you sure?</div>
      <div class="confirm-actions">
        <button class="confirm-btn-cancel" id="confirm-cancel">Cancel</button>
        <button class="confirm-btn-confirm" id="confirm-ok">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Timeline modal -->
  <div class="modal-overlay" id="timeline-modal" style="display:none">
    <div class="modal" style="max-width:600px;max-height:80vh;display:flex;flex-direction:column;">
      <div class="modal-header">
        <h3>Timeline: <span id="timeline-session-name"></span></h3>
        <button class="close-btn" onclick="closeTimeline()">&times;</button>
      </div>
      <div class="modal-body" id="timeline-content" style="overflow-y:auto;flex:1;"></div>
    </div>
  </div>

  <!-- Tasks modal -->
  <div class="modal-overlay" id="tasks-modal" style="display:none">
    <div class="modal" style="max-width:650px;max-height:85vh;display:flex;flex-direction:column;">
      <div class="modal-header">
        <h3>Tasks: <span id="tasks-session-name"></span></h3>
        <button class="close-btn" onclick="closeTasksModal()">&times;</button>
      </div>
      <div class="modal-body tasks-modal-body" style="overflow-y:auto;flex:1;">
        <div class="tasks-header">
          <div class="tasks-stats">
            <div class="tasks-stat">
              <span>Progress:</span>
              <span class="tasks-stat-value" id="tasks-progress">0/0</span>
            </div>
            <div class="tasks-stat">
              <span>Ralph:</span>
              <span class="ralph-status-badge idle" id="ralph-status-badge">IDLE</span>
            </div>
          </div>
          <div class="ralph-controls" id="ralph-controls">
            <button class="btn-start" onclick="startRalph()">Start Ralph</button>
          </div>
        </div>

        <div class="task-list" id="task-list">
          <div class="no-tasks">
            <div class="no-tasks-icon">&#128221;</div>
            <div>No tasks yet</div>
            <div style="font-size:11px;margin-top:8px">Add tasks below to start the Ralph loop</div>
          </div>
        </div>

        <div class="add-task-form" id="add-task-form">
          <input type="text" id="new-task-title" placeholder="Task title (e.g., Add user authentication)">
          <textarea id="new-task-description" placeholder="Task description (optional - what needs to be done?)"></textarea>
          <div class="form-actions">
            <button class="btn-add" onclick="addTask()">+ Add Task</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
  <script>
    let ws = null;
    let statusWs = null;
    let term = null;
    let fitAddon = null;
    let currentSession = null;
    let currentProjectPath = null;
    let activePort = null;
    let isFullscreen = false;
    let ctrlActive = false;
    let intentionalDisconnect = false;
    let fbCurrentPath = '/home';
    let dashboardVisible = false;

    // Notification sound
    let audioCtx = null;
    let notifySoundEnabled = localStorage.getItem('notifySound') !== 'false';
    let inputWaitingTimeout = null;
    let lastNotifyTime = 0;

    function playBeep() {
      if (!notifySoundEnabled) return;
      try {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.frequency.value = 800;
        gain.gain.value = 0.3;
        osc.start();
        osc.stop(audioCtx.currentTime + 0.15);
      } catch (e) {}
    }

    function checkForInputWaiting() {
      if (!term || !term.buffer) return;
      const buffer = term.buffer.active;
      const lastLine = buffer.getLine(buffer.cursorY)?.translateToString().trim() || '';

      const waitingPatterns = [
        /\[Y\/n\]/i,
        /\(y\/N\)/i,
        /\?\s*$/,
        /^\s*[$#%>]\s*$/,
        /allow|deny|approve/i,
      ];

      if (waitingPatterns.some(p => p.test(lastLine))) {
        if (Date.now() - lastNotifyTime > 3000) {
          lastNotifyTime = Date.now();
          playBeep();
        }
      }
    }

    function updateNotifyIcon() {
      document.getElementById('notify-toggle').textContent = notifySoundEnabled ? 'üîî' : 'üîï';
    }

    const isMobile = window.innerWidth <= 600;

    // --- Terminal ---
    function initTerminal() {
      if (term) term.dispose();
      const isLight = (localStorage.getItem('pg_theme') || 'dark') === 'light';
      term = new Terminal({
        cursorBlink: true,
        fontSize: isMobile ? 13 : 14,
        fontFamily: "'JetBrains Mono', 'Fira Code', 'Courier New', monospace",
        theme: isLight
          ? { background: '#f8f8fa', foreground: '#1a1a2e', cursor: '#4f46e5', selectionBackground: 'rgba(79,70,229,0.2)' }
          : { background: '#09090b', foreground: '#ececf1', cursor: '#6366f1', selectionBackground: 'rgba(99,102,241,0.3)' },
        scrollback: 5000,
        convertEol: true,
        cursorStyle: 'bar',
        cursorWidth: 2
      });
      fitAddon = new FitAddon.FitAddon();
      term.loadAddon(fitAddon);
      term.open(document.getElementById('terminal-container'));
      setTimeout(() => fitAddon.fit(), 50);

      term.writeln('\x1b[38;2;108;99;255mVibeManager\x1b[0m');
      term.writeln('\x1b[90mOpen Sessions to get started.\x1b[0m\r\n');

      term.attachCustomKeyEventHandler((ev) => {
        if (ctrlActive && ev.type === 'keydown' && ev.key.length === 1) {
          const code = ev.key.toLowerCase().charCodeAt(0) - 96;
          if (code > 0 && code < 27) {
            sendKey(String.fromCharCode(code));
            ctrlActive = false;
            document.getElementById('vkey-ctrl').classList.remove('active');
            return false;
          }
        }
        return true;
      });

      // Register terminal I/O handlers ONCE
      term.onData(data => {
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: 'data', data }));
        }
      });

      term.onResize(({ cols, rows }) => {
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: 'resize', cols, rows }));
        }
      });
    }

    function showConnectOverlay(sessionName, message) {
      const overlay = document.getElementById('connect-overlay');
      document.getElementById('co-text').textContent = message || 'Connecting...';
      document.getElementById('co-session').textContent = sessionName;
      overlay.classList.add('visible');
    }

    function hideConnectOverlay() {
      document.getElementById('connect-overlay').classList.remove('visible');
    }

    function connectSession(sessionName) {
      // Kill old connection cleanly
      if (ws) {
        intentionalDisconnect = true;
        ws.close();
        ws = null;
      }

      showConnectOverlay(sessionName, 'Attaching to session...');

      setTimeout(() => fitAddon.fit(), 100);
      const cols = term.cols;
      const rows = term.rows;
      const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${location.host}/?session=${encodeURIComponent(sessionName)}&cols=${cols}&rows=${rows}`;

      const newWs = new WebSocket(wsUrl);
      let suppressOutput = true;

      newWs.onopen = () => {
        ws = newWs;
        intentionalDisconnect = false;
        setConnected(true);
        term.reset();
        currentSession = sessionName;
        document.getElementById('session-name').textContent = sessionName;
        localStorage.setItem('pg_lastSession', sessionName);
        document.getElementById('co-text').textContent = 'Loading terminal...';
      };

      newWs.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        if (msg.type === 'data') {
          if (!suppressOutput) term.write(msg.data);
          // Check for input waiting after output settles
          clearTimeout(inputWaitingTimeout);
          inputWaitingTimeout = setTimeout(checkForInputWaiting, 600);
        } else if (msg.type === 'attached') {
          document.getElementById('status-shell').textContent = msg.shell;
          document.getElementById('session-name').textContent = `${msg.session} - ${msg.projectPath}`;
          document.title = `VibeManager | ${msg.session}`;
          currentProjectPath = msg.projectPath;
          setTimeout(() => {
            suppressOutput = false;
            hideConnectOverlay();
            if (fitAddon) fitAddon.fit();
            const dims = { cols: term.cols, rows: term.rows };
            if (newWs.readyState === WebSocket.OPEN) {
              newWs.send(JSON.stringify({ type: 'resize', cols: dims.cols, rows: dims.rows }));
            }
            setConnected(true);
          }, 150);
        } else if (msg.type === 'detached') {
          hideConnectOverlay();
          term.writeln(`\r\n\x1b[33mSession detached (${msg.reason})\x1b[0m`);
          currentProjectPath = null;
          setConnected(false);
          if (msg.reason === 'session_killed') {
            term.writeln('\x1b[90mSession was terminated. Open Sessions to revive or create new.\x1b[0m');
          }
        } else if (msg.type === 'error') {
          hideConnectOverlay();
          term.writeln(`\r\n\x1b[31m${msg.message}\x1b[0m`);
          setConnected(false);
        }
      };

      newWs.onclose = () => {
        if (ws === newWs) {
          ws = null;
          setConnected(false);
          if (!intentionalDisconnect && currentSession) {
            showConnectOverlay(currentSession, 'Reconnecting...');
            setTimeout(() => {
              if (!intentionalDisconnect && currentSession) {
                connectSession(currentSession);
              }
            }, 2000);
          } else {
            hideConnectOverlay();
          }
        }
      };

      newWs.onerror = () => {};
    }

    let codeEditorLoaded = false;

    function setConnected(connected) {
      document.getElementById('status-connection').textContent = connected ? 'Connected' : 'Disconnected';
      document.getElementById('status-dot').classList.toggle('connected', connected);

      // Reset code editor state when disconnected
      if (!connected) {
        codeEditorLoaded = false;
        const codeIframe = document.getElementById('code-iframe');
        const codePlaceholder = document.getElementById('code-placeholder');
        codeIframe.src = '';
        codeIframe.style.display = 'none';
        codePlaceholder.style.display = 'flex';
      }
    }

    function loadCodeEditor(projectPath) {
      const codeIframe = document.getElementById('code-iframe');
      const codePlaceholder = document.getElementById('code-placeholder');

      // code-server mapped via Docker: external 8083 -> internal 8080
      const codeUrl = `${location.protocol}//${location.hostname}:8083/?folder=${encodeURIComponent(projectPath)}`;

      codeIframe.src = codeUrl;
      codeIframe.style.display = 'block';
      codePlaceholder.style.display = 'none';
    }

    // --- Sessions UI ---
    async function loadSessionsList() {
      const list = document.getElementById('sessions-list');
      list.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-dim);font-size:12px">Loading...</div>';
      try {
        const res = await fetch('/api/sessions');
        const data = await res.json();
        if (data.sessions.length === 0) {
          list.innerHTML = '<div style="padding:30px;text-align:center;color:var(--text-dim);font-size:13px">No sessions yet.<br><span style="font-size:11px;opacity:0.6">Create one to get started.</span></div>';
          return;
        }
        list.innerHTML = data.sessions
          .sort((a, b) => new Date(b.lastAccessedAt) - new Date(a.lastAccessedAt))
          .map(s => `
            <div class="session-item ${s.name === currentSession ? 'active' : ''}" data-name="${s.name}">
              <div class="dot ${s.alive ? 'alive' : 'dead'}"></div>
              <div class="info" onclick="switchToSession('${s.name}')">
                <div class="name">${s.name}</div>
                <div class="path">${s.projectPath}</div>
              </div>
              <button class="del-btn" onclick="event.stopPropagation(); deleteSession('${s.name}')" title="Delete">&#10005;</button>
            </div>
          `).join('');
      } catch (err) {
        list.innerHTML = `<div style="padding:20px;text-align:center;color:var(--danger);font-size:12px">${err.message}</div>`;
      }
    }

    async function switchToSession(name) {
      document.getElementById('sessions-modal').classList.remove('open');
      connectSession(name);
      setView('terminal');
    }

    async function deleteSession(name) {
      const confirmed = await showConfirm(
        'Delete Session',
        `Delete session "${name}"? This will kill the terminal.`
      );
      if (!confirmed) return;
      try {
        await fetch(`/api/sessions/${encodeURIComponent(name)}`, { method: 'DELETE' });
        if (name === currentSession) {
          intentionalDisconnect = true;
          if (ws) ws.close();
          currentSession = null;
          currentProjectPath = null;
          document.getElementById('session-name').textContent = 'No session';
          document.title = 'VibeManager';
          setConnected(false);
          term.clear();
          term.writeln('\x1b[90mSession deleted.\x1b[0m');
        }
        loadSessionsList();
      } catch (err) {
        alert('Failed: ' + err.message);
      }
    }

    // --- New Session ---
    async function fbBrowse(dirPath) {
      fbCurrentPath = dirPath;
      document.getElementById('fb-path').textContent = dirPath;
      const list = document.getElementById('fb-list');
      list.innerHTML = '<div style="padding:12px;text-align:center;color:var(--text-dim);font-size:11px">...</div>';
      try {
        const res = await fetch(`/api/browse?path=${encodeURIComponent(dirPath)}`);
        const data = await res.json();
        if (data.error) { list.innerHTML = `<div style="padding:12px;color:var(--danger);font-size:11px">${data.error}</div>`; return; }
        if (data.folders.length === 0) {
          list.innerHTML = '<div style="padding:12px;text-align:center;color:var(--text-dim);font-size:11px">Empty</div>';
        } else {
          list.innerHTML = data.folders.map(f => {
            const safePath = f.path.replace(/'/g, "\\'");
            return `<div class="fb-item" onclick="fbBrowse('${safePath}')">&#128193; ${f.name}</div>`;
          }).join('');
        }
      } catch (err) {
        list.innerHTML = `<div style="padding:12px;color:var(--danger);font-size:11px">${err.message}</div>`;
      }
    }

    async function fbCreateFolder() {
      const input = document.getElementById('fb-new-folder');
      const name = input.value.trim();
      if (!name) return;
      try {
        const res = await fetch('/api/mkdir', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ parentPath: fbCurrentPath, name })
        });
        const data = await res.json();
        if (data.error) { alert(data.error); return; }
        input.value = '';
        fbBrowse(fbCurrentPath);
      } catch (err) { alert(err.message); }
    }

    let sourceMode = 'folder'; // 'folder' or 'git'
    let selectedTool = 'opencode'; // 'opencode', 'claude', or 'bash'

    async function createSession() {
      const btn = document.getElementById('btn-create-session');
      let name = document.getElementById('input-session-name').value.trim();
      let projectPath = fbCurrentPath;

      if (sourceMode === 'git') {
        const gitUrl = document.getElementById('input-git-url').value.trim();
        if (!gitUrl) { alert('Enter a git URL'); return; }

        btn.textContent = 'Cloning...';
        btn.classList.add('loading');

        try {
          const cloneRes = await fetch('/api/clone', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ gitUrl, name: name || undefined })
          });
          const cloneData = await cloneRes.json();
          if (cloneData.error) {
            // If directory exists, use it anyway
            if (cloneData.path) {
              projectPath = cloneData.path;
              if (!name) name = cloneData.name;
            } else {
              alert(cloneData.error);
              btn.textContent = 'Create & Open';
              btn.classList.remove('loading');
              return;
            }
          } else {
            projectPath = cloneData.path;
            if (!name) name = cloneData.name;
          }
        } catch (err) {
          alert('Clone failed: ' + err.message);
          btn.textContent = 'Create & Open';
          btn.classList.remove('loading');
          return;
        }
      }

      if (!name) {
        // Auto-generate name from path
        name = projectPath.split('/').filter(Boolean).pop() || 'session';
        name = name.replace(/[^a-zA-Z0-9_-]/g, '-');
      }

      if (!/^[a-zA-Z0-9_-]{1,50}$/.test(name)) { alert('Name: letters, numbers, dashes, underscores only (1-50 chars)'); btn.textContent = 'Create & Open'; btn.classList.remove('loading'); return; }

      btn.textContent = 'Creating...';
      btn.classList.add('loading');

      const initialPrompt = selectedTool !== 'bash' ? document.getElementById('input-initial-prompt').value.trim() : '';
      const autonomous = selectedTool !== 'bash' && document.getElementById('input-autonomous').checked;

      try {
        const res = await fetch('/api/sessions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, projectPath, initialPrompt, shell: selectedTool, autonomous })
        });
        const data = await res.json();
        if (data.error) { alert(data.error); btn.textContent = 'Create & Open'; btn.classList.remove('loading'); return; }

        document.getElementById('new-session-modal').classList.remove('open');
        document.getElementById('input-session-name').value = '';
        document.getElementById('input-git-url').value = '';
        document.getElementById('input-initial-prompt').value = '';
        btn.textContent = 'Create & Open';
        btn.classList.remove('loading');
        connectSession(name);
        setView('terminal');
      } catch (err) {
        alert('Failed: ' + err.message);
        btn.textContent = 'Create & Open';
        btn.classList.remove('loading');
      }
    }

    // --- Ports ---
    function renderPorts(ports) {
      const container = document.getElementById('ports-container');
      if (!ports || ports.length === 0) {
        container.innerHTML = '<span style="font-size:11px;color:var(--text-dim)">--</span>';
      } else {
        container.innerHTML = ports.map(p =>
          `<button class="port-btn ${p === activePort ? 'active' : ''}" onclick="selectPort(${p})">${p}</button>`
        ).join(' ');
      }
    }

    function selectPort(port) {
      activePort = port;
      const url = `http://${location.hostname}:${port}`;
      loadPreviewUrl(url);
      document.querySelectorAll('.port-btn').forEach(btn => {
        btn.classList.toggle('active', parseInt(btn.textContent) === port);
      });
    }

    function loadPreviewUrl(url) {
      const iframe = document.getElementById('preview-iframe');
      const placeholder = document.getElementById('preview-placeholder');
      const urlBar = document.getElementById('preview-url-bar');
      const urlInput = document.getElementById('preview-url-input');
      iframe.src = url;
      iframe.style.display = 'block';
      placeholder.style.display = 'none';
      urlBar.style.display = 'flex';
      urlInput.value = url;
    }

    // --- Dashboard ---

    // --- Cross-Session Memory ---
    let memoryData = null;

    async function loadMemory() {
      try {
        const [memoryRes, patternsRes] = await Promise.all([
          fetch('/api/memory'),
          fetch('/api/memory/patterns')
        ]);

        memoryData = await memoryRes.json();
        const patterns = await patternsRes.json();

        renderMemory(memoryData, patterns);
      } catch (err) {
        console.error('Failed to load memory:', err);
        document.getElementById('memory-entries').innerHTML = `
          <div class="memory-empty">Failed to load memory</div>
        `;
      }
    }

    function renderMemory(memory, patterns) {
      const statsEl = document.getElementById('memory-stats');
      const entriesEl = document.getElementById('memory-entries');
      const prefsEl = document.getElementById('memory-tech-prefs');

      // Stats
      const entryCount = memory.entries?.length || 0;
      const patternCount = patterns.patterns?.length || 0;
      const techCount = Object.keys(patterns.techPreferences || {}).length;

      statsEl.innerHTML = `
        <div class="memory-stat">
          <span>Entries:</span>
          <span class="memory-stat-value">${entryCount}</span>
        </div>
        <div class="memory-stat">
          <span>Patterns:</span>
          <span class="memory-stat-value">${patternCount}</span>
        </div>
        <div class="memory-stat">
          <span>Technologies:</span>
          <span class="memory-stat-value">${techCount}</span>
        </div>
        ${memory.lastUpdated ? `
          <div class="memory-stat">
            <span>Updated:</span>
            <span class="memory-stat-value">${relativeTime(memory.lastUpdated)}</span>
          </div>
        ` : ''}
      `;

      // Recent entries (last 5)
      const recentEntries = (memory.entries || []).slice(-5).reverse();

      if (recentEntries.length === 0) {
        entriesEl.innerHTML = `
          <div class="memory-empty">
            No memories yet. Click "Aggregate" to extract learnings from sessions.
          </div>
        `;
      } else {
        entriesEl.innerHTML = recentEntries.map(entry => `
          <div class="memory-entry">
            <div class="memory-entry-header">
              <span class="memory-entry-type ${escapeHtml(entry.type)}">${escapeHtml(entry.type)}</span>
              <span class="memory-entry-source">${escapeHtml(entry.source)} ‚Ä¢ ${relativeTime(entry.timestamp)}</span>
            </div>
            <div class="memory-entry-content">${escapeHtml(entry.content.substring(0, 200))}${entry.content.length > 200 ? '...' : ''}</div>
            ${entry.tags?.length > 0 ? `
              <div class="memory-entry-tags">
                ${entry.tags.map(tag => `<span class="memory-tag">${escapeHtml(tag)}</span>`).join('')}
              </div>
            ` : ''}
          </div>
        `).join('');
      }

      // Tech preferences (top 10)
      const techPrefs = Object.entries(patterns.techPreferences || {}).slice(0, 10);

      if (techPrefs.length > 0) {
        prefsEl.innerHTML = techPrefs.map(([tech, count]) => `
          <div class="tech-pref-tag">
            <span>${escapeHtml(tech)}</span>
            <span class="tech-pref-count">${count}</span>
          </div>
        `).join('');
      } else {
        prefsEl.innerHTML = '';
      }
    }

    async function aggregateMemories() {
      try {
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = 'Aggregating...';

        const res = await fetch('/api/memory/aggregate', { method: 'POST' });
        const result = await res.json();

        if (res.ok) {
          showToast(`Aggregated ${result.newEntriesCount} new entries`);
          await loadMemory();
        } else {
          showToast(`Error: ${result.error}`, 'error');
        }
      } catch (err) {
        showToast(`Error: ${err.message}`, 'error');
      } finally {
        event.target.disabled = false;
        event.target.textContent = 'Aggregate';
      }
    }

    async function refreshMemory() {
      await loadMemory();
      showToast('Memory refreshed');
    }

    // Toast notification helper
    function showToast(message, type = 'success') {
      // Create toast element if it doesn't exist
      let toast = document.getElementById('toast-notification');
      if (!toast) {
        toast = document.createElement('div');
        toast.id = 'toast-notification';
        toast.style.cssText = `
          position: fixed;
          bottom: 60px;
          left: 50%;
          transform: translateX(-50%);
          padding: 10px 20px;
          background: var(--surface2);
          color: var(--text);
          font-size: 12px;
          z-index: 10000;
          opacity: 0;
          transition: opacity 0.3s;
        `;
        document.body.appendChild(toast);
      }

      toast.textContent = message;
      toast.style.background = type === 'error' ? 'var(--danger)' : 'var(--surface2)';
      toast.style.opacity = '1';

      setTimeout(() => {
        toast.style.opacity = '0';
      }, 3000);
    }

    function relativeTime(isoString) {
      if (!isoString) return '';
      const diff = Math.floor((Date.now() - new Date(isoString).getTime()) / 1000);
      if (diff < 60) return 'just now';
      if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
      if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
      return Math.floor(diff / 86400) + 'd ago';
    }

    function formatUptime(seconds) {
      if (seconds < 60) return seconds + 's';
      if (seconds < 3600) return Math.floor(seconds / 60) + 'm';
      if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ' + Math.floor((seconds % 3600) / 60) + 'm';
      return Math.floor(seconds / 86400) + 'd ' + Math.floor((seconds % 86400) / 3600) + 'h';
    }

    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function shortenPath(p) {
      // Replace /home/username or /Users/username with ~
      const homeMatch = p.match(/^\/(?:home|Users)\/[^/]+/);
      if (homeMatch) return '~' + p.slice(homeMatch[0].length);
      return p;
    }

    function renderDashboard(data) {
      if (!dashboardVisible) return;

      document.getElementById('stats-bar').innerHTML = `
        <div class="stat-item running"><div><div class="stat-value">${data.stats.running}</div><div class="stat-label">Running</div></div></div>
        <div class="stat-item stopped"><div><div class="stat-value">${data.stats.stopped}</div><div class="stat-label">Stopped</div></div></div>
        <div class="stat-item total"><div><div class="stat-value">${data.stats.total}</div><div class="stat-label">Total</div></div></div>
        <div class="stat-item uptime"><div><div class="stat-value">${formatUptime(data.stats.uptime)}</div><div class="stat-label">Uptime</div></div></div>
      `;

      const grid = document.getElementById('cards-grid');
      if (data.sessions.length === 0) {
        grid.innerHTML = `
          <div class="dashboard-empty" style="grid-column: 1 / -1;">
            <div class="icon">&#9881;</div>
            <p>No projects yet</p>
            <p style="font-size:12px;opacity:0.5">Click "+ New Project" to start building</p>
          </div>
        `;
        return;
      }

      grid.innerHTML = data.sessions
        .sort((a, b) => (b.alive ? 1 : 0) - (a.alive ? 1 : 0) || new Date(b.lastAccessedAt) - new Date(a.lastAccessedAt))
        .map(s => {
          // Task progress bar (data comes from our backend, not user input)
          let taskHtml = '';
          if (s.tasks && s.tasks.total > 0) {
            const pct = Math.round((s.tasks.completed / s.tasks.total) * 100);
            const loopStatus = s.loopConfig?.status || 'idle';
            const statusClass = loopStatus === 'running' ? 'ralph-running' :
                               loopStatus === 'stuck' ? 'ralph-stuck' :
                               loopStatus === 'complete' ? 'ralph-complete' : '';
            taskHtml = `
              <div class="card-tasks ${statusClass}">
                <div class="task-progress">
                  <div class="task-bar" style="width: ${pct}%"></div>
                </div>
                <div class="task-info">
                  <span>${s.tasks.completed}/${s.tasks.total} tasks</span>
                  ${loopStatus !== 'idle' ? `<span class="ralph-status">${loopStatus.toUpperCase()}</span>` : ''}
                </div>
                ${s.tasks.current ? `<div class="task-current">${escapeHtml(s.tasks.current)}</div>` : ''}
              </div>
            `;
          }

          // Last summary preview
          let summaryHtml = '';
          if (s.lastSummary?.content) {
            summaryHtml = `<div class="card-summary">${escapeHtml(s.lastSummary.content.substring(0, 100))}...</div>`;
          }

          return `
          <div class="session-card ${s.alive ? 'alive' : 'dead'} ${s.loopConfig?.status === 'stuck' ? 'stuck' : ''}">
            <div class="card-header">
              <div class="card-dot ${s.alive ? 'alive' : ''}"></div>
              <span class="card-name">${escapeHtml(s.name)}</span>
            </div>
            <div class="card-path">${escapeHtml(shortenPath(s.projectPath))}</div>
            ${taskHtml}
            ${summaryHtml}
            <div class="card-meta">
              <span>${escapeHtml(s.shell)}</span>
              <span>${relativeTime(s.lastAccessedAt)}</span>
            </div>
            <div class="card-actions">
              ${s.alive ? `
                <button class="btn-attach" onclick="attachFromDash('${escapeHtml(s.name)}')">Attach</button>
                <button class="btn-stop" onclick="stopFromDash('${escapeHtml(s.name)}')">Stop</button>
              ` : `
                <button class="btn-revive" onclick="reviveFromDash('${escapeHtml(s.name)}')">Revive</button>
                <button class="btn-delete" onclick="deleteFromDash('${escapeHtml(s.name)}')">Delete</button>
              `}
              <button class="btn-timeline" onclick="showTimeline('${escapeHtml(s.name)}')" title="Timeline">&#128337;</button>
              <button class="btn-tasks" onclick="showTasksModal('${escapeHtml(s.name)}')" title="Tasks & Ralph">&#128221;</button>
            </div>
          </div>
        `}).join('');
    }

    // Custom confirmation modal
    function showConfirm(title, message) {
      return new Promise((resolve) => {
        const modal = document.getElementById('confirm-modal');
        const titleEl = document.getElementById('confirm-title');
        const messageEl = document.getElementById('confirm-message');
        const cancelBtn = document.getElementById('confirm-cancel');
        const okBtn = document.getElementById('confirm-ok');

        titleEl.textContent = title;
        messageEl.textContent = message;
        modal.classList.add('visible');

        const cleanup = () => {
          modal.classList.remove('visible');
          cancelBtn.removeEventListener('click', onCancel);
          okBtn.removeEventListener('click', onOk);
        };

        const onCancel = () => {
          cleanup();
          resolve(false);
        };

        const onOk = () => {
          cleanup();
          resolve(true);
        };

        cancelBtn.addEventListener('click', onCancel);
        okBtn.addEventListener('click', onOk);
      });
    }

    function attachFromDash(name) {
      connectSession(name);
      setView('terminal');
    }

    async function stopFromDash(name) {
      const confirmed = await showConfirm(
        'Stop Session',
        `Stop session "${name}"? The tmux process will be killed but you can revive it later.`
      );
      if (!confirmed) return;
      try {
        await fetch(`/api/sessions/${encodeURIComponent(name)}/stop`, { method: 'POST' });
        if (currentSession === name) {
          intentionalDisconnect = true;
          if (ws) { ws.close(); ws = null; }
          currentSession = null;
          currentProjectPath = null;
          document.getElementById('session-name').textContent = 'No session';
          document.title = 'VibeManager';
          setConnected(false);
        }
      } catch (err) {
        alert('Failed to stop: ' + err.message);
      }
    }

    async function reviveFromDash(name) {
      try {
        await fetch(`/api/sessions/${encodeURIComponent(name)}/revive`, { method: 'POST' });
      } catch (err) {
        alert('Failed to revive: ' + err.message);
      }
    }

    async function deleteFromDash(name) {
      const confirmed = await showConfirm(
        'Delete Session',
        `Permanently delete session "${name}"? This cannot be undone.`
      );
      if (!confirmed) return;
      try {
        await fetch(`/api/sessions/${encodeURIComponent(name)}`, { method: 'DELETE' });
        if (currentSession === name) {
          intentionalDisconnect = true;
          if (ws) { ws.close(); ws = null; }
          currentSession = null;
          currentProjectPath = null;
          document.getElementById('session-name').textContent = 'No session';
          document.title = 'VibeManager';
          setConnected(false);
        }
      } catch (err) {
        alert('Failed to delete: ' + err.message);
      }
    }

    // Timeline modal
    async function showTimeline(sessionName) {
      const modal = document.getElementById('timeline-modal');
      const content = document.getElementById('timeline-content');
      content.textContent = 'Loading...';
      content.style.textAlign = 'center';
      content.style.padding = '40px';
      modal.style.display = 'flex';
      document.getElementById('timeline-session-name').textContent = sessionName;

      try {
        // Fetch checkpoints and progress in parallel
        const [checkpointsRes, progressRes, tasksRes] = await Promise.all([
          fetch(`/api/sessions/${encodeURIComponent(sessionName)}/checkpoints`),
          fetch(`/api/sessions/${encodeURIComponent(sessionName)}/progress`),
          fetch(`/api/sessions/${encodeURIComponent(sessionName)}/tasks`)
        ]);

        const checkpoints = (await checkpointsRes.json()).checkpoints || [];
        const progress = (await progressRes.json()).entries || [];
        const tasks = (await tasksRes.json()).tasks || [];

        // Build timeline items
        const items = [];

        // Add checkpoints
        for (const cp of checkpoints) {
          items.push({
            type: 'checkpoint',
            timestamp: new Date(cp.timestamp),
            data: cp
          });
        }

        // Add progress entries (last 20)
        for (const p of progress.slice(-20)) {
          if (p.timestamp) {
            items.push({
              type: 'progress',
              timestamp: new Date(p.timestamp),
              data: p
            });
          }
        }

        // Sort by timestamp descending
        items.sort((a, b) => b.timestamp - a.timestamp);

        content.style.textAlign = '';
        content.style.padding = '';

        if (items.length === 0) {
          content.textContent = 'No timeline events yet';
          content.style.textAlign = 'center';
          content.style.padding = '40px';
          return;
        }

        // Build HTML safely - data comes from our backend
        const html = items.map(item => {
          if (item.type === 'checkpoint') {
            const cp = item.data;
            return `
              <div class="timeline-item checkpoint">
                <div class="timeline-marker">&#128205;</div>
                <div class="timeline-card">
                  <div class="timeline-time">${relativeTime(cp.timestamp)}</div>
                  <div class="timeline-title">${escapeHtml(cp.name)}</div>
                  ${cp.tasks ? `<div class="timeline-meta">Tasks: ${cp.tasks.completed}/${cp.tasks.total}</div>` : ''}
                  ${cp.git ? `<div class="timeline-meta">Git: ${escapeHtml(cp.git.commit)} on ${escapeHtml(cp.git.branch)}</div>` : ''}
                  ${cp.summary ? `<div class="timeline-summary">${escapeHtml(cp.summary)}</div>` : ''}
                  <div class="timeline-actions">
                    <button onclick="restoreCheckpoint('${escapeHtml(sessionName)}', '${escapeHtml(cp.id)}')">Restore</button>
                    <button onclick="viewScrollback('${escapeHtml(sessionName)}', '${cp.scrollback?.timestamp || 'latest'}')">View Output</button>
                  </div>
                </div>
              </div>
            `;
          } else {
            const p = item.data;
            const iconMap = {
              task: '&#128736;',
              success: '&#10004;',
              error: '&#10060;',
              learning: '&#128161;',
              iteration: '&#128260;',
              checkpoint: '&#128205;',
              info: '&#128221;'
            };
            return `
              <div class="timeline-item progress ${escapeHtml(p.category)}">
                <div class="timeline-marker">${iconMap[p.category] || '&#8226;'}</div>
                <div class="timeline-card small">
                  <div class="timeline-time">${relativeTime(p.timestamp)}</div>
                  <div class="timeline-content">${escapeHtml(p.content)}</div>
                </div>
              </div>
            `;
          }
        }).join('');
        content.innerHTML = html;

      } catch (err) {
        content.textContent = 'Error: ' + err.message;
        content.style.color = 'var(--danger)';
      }
    }

    function closeTimeline() {
      document.getElementById('timeline-modal').style.display = 'none';
    }

    async function restoreCheckpoint(sessionName, checkpointId) {
      const confirmed = await showConfirm(
        'Restore Checkpoint',
        'This will show the checkpoint context. Do you also want to restore git state?'
      );
      if (confirmed === null) return;

      try {
        const res = await fetch(`/api/sessions/${encodeURIComponent(sessionName)}/checkpoints/${checkpointId}/restore`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ restoreGit: confirmed })
        });
        const result = await res.json();
        if (result.warnings?.length) {
          alert('Warnings: ' + result.warnings.join('\n'));
        } else {
          alert('Checkpoint restored');
        }
      } catch (err) {
        alert('Failed to restore: ' + err.message);
      }
    }

    async function viewScrollback(sessionName, timestamp) {
      try {
        const res = await fetch(`/api/sessions/${encodeURIComponent(sessionName)}/scrollback/${timestamp}`);
        const data = await res.json();
        if (data.content) {
          // Create a blob URL for safe display
          const blob = new Blob([data.content], { type: 'text/plain' });
          const url = URL.createObjectURL(blob);
          window.open(url, '_blank');
        }
      } catch (err) {
        alert('Failed to load scrollback: ' + err.message);
      }
    }

    // --- Tasks Modal ---
    let currentTasksSession = null;

    async function showTasksModal(sessionName) {
      currentTasksSession = sessionName;
      document.getElementById('tasks-session-name').textContent = sessionName;
      document.getElementById('tasks-modal').style.display = 'flex';

      // Clear form
      document.getElementById('new-task-title').value = '';
      document.getElementById('new-task-description').value = '';

      await refreshTasksModal();
    }

    function closeTasksModal() {
      document.getElementById('tasks-modal').style.display = 'none';
      currentTasksSession = null;
    }

    async function refreshTasksModal() {
      if (!currentTasksSession) return;

      try {
        // Fetch tasks and Ralph status in parallel
        const [tasksRes, ralphRes] = await Promise.all([
          fetch(`/api/sessions/${encodeURIComponent(currentTasksSession)}/tasks`),
          fetch(`/api/sessions/${encodeURIComponent(currentTasksSession)}/ralph/status`)
        ]);

        const tasksData = await tasksRes.json();
        const ralphData = await ralphRes.json();

        renderTasksModal(tasksData, ralphData);
      } catch (err) {
        console.error('Failed to load tasks:', err);
      }
    }

    // Real-time task progress update
    function updateTaskProgress(sessionName, data) {
      if (currentTasksSession !== sessionName) return;

      const taskElement = document.querySelector(`[data-task-id="${data.taskId}"]`);
      if (!taskElement) return;

      const progressBar = taskElement.querySelector('.task-progress-fill');
      const progressText = taskElement.querySelector('.task-progress-text');

      if (progressBar) {
        progressBar.style.width = `${data.progress || 0}%`;
      }

      if (progressText) {
        const statusText = data.status && data.status !== 'pending' && data.status !== 'completed' ? ` - ${data.status}` : '';
        progressText.textContent = `${data.progress || 0}%${statusText}`;
      }

      // Update live status if available
      const liveStatus = taskElement.querySelector('.task-live-status span:last-child');
      if (liveStatus && data.currentStep) {
        liveStatus.textContent = data.currentStep;
      }
    }

    // Real-time task step update
    function updateTaskStep(sessionName, data) {
      if (currentTasksSession !== sessionName) return;

      const taskElement = document.querySelector(`[data-task-id="${data.taskId}"]`);
      if (!taskElement) return;

      const stepElement = taskElement.querySelector(`.task-step[data-step="${data.completedStep}"]`);
      if (stepElement) {
        stepElement.className = 'task-step completed';
        stepElement.textContent = `‚úì ${data.completedStep}`;
      }
    }

    // Handle Ralph loop updates
    function handleRalphUpdate(sessionName, data) {
      if (currentTasksSession !== sessionName) return;
      // Full refresh on Ralph updates
      refreshTasksModal();
    }

    function renderTasksModal(tasksData, ralphData) {
      const tasks = tasksData.tasks || [];
      const stats = tasksData.stats || { total: 0, completed: 0, currentId: null };
      const ralphStatus = ralphData.status || 'idle';

      // Update progress
      document.getElementById('tasks-progress').textContent = `${stats.completed}/${stats.total}`;

      // Update Ralph status badge
      const badge = document.getElementById('ralph-status-badge');
      badge.textContent = ralphStatus.toUpperCase();
      badge.className = `ralph-status-badge ${ralphStatus}`;

      // Update Ralph controls
      const controls = document.getElementById('ralph-controls');
      if (ralphStatus === 'running') {
        controls.innerHTML = `
          <button class="btn-pause" onclick="pauseRalph()">Pause</button>
          <button class="btn-stop" onclick="stopRalph()">Stop</button>
        `;
      } else if (ralphStatus === 'stuck') {
        controls.innerHTML = `
          <button class="btn-start" onclick="resumeWithVerification()" style="background: var(--accent);">Verify & Resume</button>
          <button class="btn-start" onclick="resumeRalph()">Force Resume</button>
          <button class="btn-stop" onclick="stopRalph()">Stop</button>
        `;
      } else if (ralphStatus === 'paused') {
        controls.innerHTML = `
          <button class="btn-start" onclick="resumeRalph()">Resume</button>
          <button class="btn-stop" onclick="stopRalph()">Stop</button>
        `;
      } else {
        controls.innerHTML = `
          <button class="btn-start" onclick="startRalph()" ${tasks.length === 0 ? 'disabled' : ''}>Start Ralph</button>
        `;
      }

      // Render task list
      const taskList = document.getElementById('task-list');
      if (tasks.length === 0) {
        taskList.innerHTML = `
          <div class="no-tasks">
            <div class="no-tasks-icon">&#128221;</div>
            <div>No tasks yet</div>
            <div style="font-size:11px;margin-top:8px">Add tasks below to start the Ralph loop</div>
          </div>
        `;
        return;
      }

      taskList.innerHTML = tasks.map(task => {
        const isCompleted = task.passes === true;
        const isCurrent = task.id === stats.currentId;
        const progress = task.progress || 0;
        const status = task.status || (isCompleted ? 'completed' : 'pending');
        const steps = task.steps || [];

        let stepsHtml = '';
        if (steps.length > 0) {
          stepsHtml = '<div class="task-steps">';
          for (const step of steps) {
            const icon = step.status === 'completed' ? '‚úì' : step.status === 'in-progress' ? '‚óâ' : '‚óã';
            stepsHtml += `<span class="task-step ${step.status}">${icon} ${escapeHtml(step.name)}</span>`;
          }
          stepsHtml += '</div>';
        }

        let progressHtml = '';
        if (isCurrent || isCompleted || progress > 0) {
          const statusText = (status !== 'pending' && status !== 'completed') ? ` - ${escapeHtml(status)}` : '';
          progressHtml = `
            <div class="task-progress-bar">
              <div class="task-progress-fill" style="width: ${progress}%"></div>
            </div>
            <div class="task-progress-text">${progress}%${statusText}</div>
          `;
        }

        const liveStatusHtml = (isCurrent && ralphStatus === 'running') ?
          '<div class="task-live-status"><span class="pulse-dot"></span><span>Working on this task...</span></div>' : '';

        const taskId = escapeHtml(task.id);
        const title = escapeHtml(task.title);
        const desc = task.description ? `<div class="task-description">${escapeHtml(task.description)}</div>` : '';
        const doneBtn = !isCompleted ? `<button onclick="markTaskComplete('${taskId}')">&#10003; Done</button>` : '';
        const checkbox = isCompleted ? '&#10003;' : isCurrent ? '&#9654;' : '';
        const classes = `task-item ${isCompleted ? 'completed' : ''} ${isCurrent ? 'current' : ''}`;

        return `
          <div class="${classes}" data-task-id="${taskId}">
            <div class="task-checkbox">${checkbox}</div>
            <div class="task-content">
              <div class="task-title">${title}</div>
              ${desc}
              ${progressHtml}
              ${stepsHtml}
              ${liveStatusHtml}
            </div>
            <div class="task-actions">
              ${doneBtn}
              <button onclick="deleteTask('${taskId}')">&#128465;</button>
            </div>
          </div>
        `;
      }).join('');
    }

    async function addTask() {
      if (!currentTasksSession) return;

      const title = document.getElementById('new-task-title').value.trim();
      const description = document.getElementById('new-task-description').value.trim();

      if (!title) {
        alert('Please enter a task title');
        return;
      }

      try {
        const res = await fetch(`/api/sessions/${encodeURIComponent(currentTasksSession)}/tasks`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, description })
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || 'Failed to add task');
        }

        // Clear form and refresh
        document.getElementById('new-task-title').value = '';
        document.getElementById('new-task-description').value = '';
        await refreshTasksModal();
        showToast('Task added');
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function markTaskComplete(taskId) {
      if (!currentTasksSession) return;

      try {
        await fetch(`/api/sessions/${encodeURIComponent(currentTasksSession)}/tasks/${taskId}/complete`, {
          method: 'POST'
        });
        await refreshTasksModal();
        showToast('Task marked complete');
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function deleteTask(taskId) {
      if (!currentTasksSession) return;
      if (!confirm('Delete this task?')) return;

      try {
        await fetch(`/api/sessions/${encodeURIComponent(currentTasksSession)}/tasks/${taskId}`, {
          method: 'DELETE'
        });
        await refreshTasksModal();
        showToast('Task deleted');
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function startRalph() {
      if (!currentTasksSession) return;

      try {
        const res = await fetch(`/api/sessions/${encodeURIComponent(currentTasksSession)}/ralph/start`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ maxIterations: 50 })
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || 'Failed to start Ralph');
        }

        await refreshTasksModal();
        showToast('Ralph loop started');
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function pauseRalph() {
      if (!currentTasksSession) return;

      try {
        await fetch(`/api/sessions/${encodeURIComponent(currentTasksSession)}/ralph/pause`, {
          method: 'POST'
        });
        await refreshTasksModal();
        showToast('Ralph paused');
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function resumeRalph() {
      if (!currentTasksSession) return;

      try {
        await fetch(`/api/sessions/${encodeURIComponent(currentTasksSession)}/ralph/resume`, {
          method: 'POST'
        });
        await refreshTasksModal();
        showToast('Ralph resumed');
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function resumeWithVerification() {
      if (!currentTasksSession) return;

      try {
        const response = await fetch(`/api/sessions/${encodeURIComponent(currentTasksSession)}/ralph/verify`, {
          method: 'POST'
        });
        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || 'Failed to start verification');
        }

        await refreshTasksModal();
        showToast('Verification prompt sent - Claude will confirm if task is complete');
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function stopRalph() {
      if (!currentTasksSession) return;

      try {
        await fetch(`/api/sessions/${encodeURIComponent(currentTasksSession)}/ralph/stop`, {
          method: 'POST'
        });
        await refreshTasksModal();
        showToast('Ralph stopped');
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // --- Session Switcher ---
    const sessionIcons = ['‚óÜ', '‚óè', '‚ñ†', '‚ñ≤', '‚òÖ', '‚óà', '‚óâ', '‚ñ£', '‚óç', '‚¨ü'];

    function renderSessionSwitcher(sessions) {
      const container = document.getElementById('session-switcher');
      const alive = (sessions || []).filter(s => s.alive)
        .sort((a, b) => new Date(b.lastAccessedAt) - new Date(a.lastAccessedAt))
        .slice(0, 3);
      if (alive.length < 2) {
        container.innerHTML = '';
        return;
      }
      container.innerHTML = alive.map((s, i) => {
        const isActive = s.name === currentSession;
        const icon = sessionIcons[i % sessionIcons.length];
        return `<button class="ss-btn ${isActive ? 'active' : ''}" data-index="${i + 1}" onclick="quickSwitch('${s.name}', true)" title="${s.name}"><span class="ss-dot"></span><span class="ss-name">${icon} ${s.name}</span></button>`;
      }).join('');
    }

    function quickSwitch(name) {
      if (name === currentSession) return;
      connectSession(name);
      setView('terminal');
    }

    function openNewSessionModal() {
      document.getElementById('new-session-modal').classList.add('open');
      fbBrowse(fbCurrentPath || '/home');
    }

    // --- System Monitor ---
    const cpuHistory = [];
    const memHistory = [];
    let prevNet = null;

    const SPARK_CHARS = '‚ñÅ‚ñÇ‚ñÉ‚ñÑ‚ñÖ‚ñÜ‚ñá‚ñà';
    const BAR_FILLED = '‚ñà';
    const BAR_EMPTY = '‚ñë';

    function makeBar(percent, width = 20) {
      const filled = Math.round(percent / 100 * width);
      const empty = width - filled;
      return `<span class="filled">${BAR_FILLED.repeat(filled)}</span><span class="empty">${BAR_EMPTY.repeat(empty)}</span>`;
    }

    function makeSparkline(history, maxLen = 24) {
      const data = history.slice(-maxLen);
      if (data.length === 0) return '';
      const max = Math.max(...data, 1);
      return data.map(v => {
        const idx = Math.min(Math.floor(v / max * (SPARK_CHARS.length - 1)), SPARK_CHARS.length - 1);
        return SPARK_CHARS[idx];
      }).join('');
    }

    function formatBytes(kb) {
      if (kb < 1024) return kb + ' KB';
      if (kb < 1048576) return (kb / 1024).toFixed(1) + ' MB';
      return (kb / 1048576).toFixed(1) + ' GB';
    }

    function formatBytesRaw(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
      if (bytes < 1073741824) return (bytes / 1048576).toFixed(1) + ' MB';
      return (bytes / 1073741824).toFixed(1) + ' GB';
    }

    function tempClass(t) {
      if (t >= 70) return 'hot';
      if (t >= 55) return 'warm';
      return 'cool';
    }

    function renderSysmon(d) {
      if (!dashboardVisible) return;

      cpuHistory.push(d.cpu.percent);
      if (cpuHistory.length > 30) cpuHistory.shift();
      memHistory.push(d.mem.percent);
      if (memHistory.length > 30) memHistory.shift();

      let netSpeed = { rx: 0, tx: 0 };
      if (prevNet) {
        netSpeed.rx = Math.max(0, d.net.rx - prevNet.rx);
        netSpeed.tx = Math.max(0, d.net.tx - prevNet.tx);
      }
      prevNet = { rx: d.net.rx, tx: d.net.tx };

      const tc = tempClass(d.temp);
      const grid = document.getElementById('sysmon-grid');
      grid.innerHTML = `
        <div class="sysmon-item">
          <div class="sysmon-label"><span>CPU</span><span class="sysmon-value">${d.cpu.percent}%</span></div>
          <div class="sysmon-bar ${d.cpu.percent > 80 ? 'hot' : d.cpu.percent > 50 ? 'warm' : 'cool'}">${makeBar(d.cpu.percent)}</div>
          <div class="sysmon-sparkline">${makeSparkline(cpuHistory)}</div>
        </div>
        <div class="sysmon-item">
          <div class="sysmon-label"><span>Memory</span><span class="sysmon-value">${d.mem.percent}%</span></div>
          <div class="sysmon-bar ${d.mem.percent > 85 ? 'hot' : d.mem.percent > 60 ? 'warm' : 'cool'}">${makeBar(d.mem.percent)}</div>
          <div class="sysmon-sparkline">${makeSparkline(memHistory)}</div>
          <div class="sysmon-label"><span>${formatBytes(d.mem.used)} / ${formatBytes(d.mem.total)}</span></div>
        </div>
        <div class="sysmon-item">
          <div class="sysmon-label"><span>Temp</span></div>
          <div class="sysmon-temp ${tc}">${d.temp}¬∞C</div>
          <div class="sysmon-bar ${tc}">${makeBar(Math.min(d.temp, 85) / 85 * 100)}</div>
        </div>
        <div class="sysmon-item">
          <div class="sysmon-label"><span>Disk /</span><span class="sysmon-value">${d.disk.percent}%</span></div>
          <div class="sysmon-bar ${d.disk.percent > 90 ? 'hot' : d.disk.percent > 70 ? 'warm' : 'cool'}">${makeBar(d.disk.percent)}</div>
          <div class="sysmon-label"><span>${formatBytesRaw(d.disk.used)} / ${formatBytesRaw(d.disk.total)}</span></div>
        </div>
        <div class="sysmon-item">
          <div class="sysmon-label"><span>Load Avg</span></div>
          <div class="sysmon-load">
            <span>${d.load[0].toFixed(2)}</span>
            <span style="opacity:0.6">${d.load[1].toFixed(2)}</span>
            <span style="opacity:0.4">${d.load[2].toFixed(2)}</span>
          </div>
          <div class="sysmon-label"><span>${d.cpu.cores} cores</span></div>
        </div>
        <div class="sysmon-item">
          <div class="sysmon-label"><span>Network</span></div>
          <div class="sysmon-net">
            <span class="rx">‚ñº ${formatBytesRaw(netSpeed.rx)}/s</span>
            <span class="tx">‚ñ≤ ${formatBytesRaw(netSpeed.tx)}/s</span>
          </div>
          <div class="sysmon-label"><span>Total: ‚ñº${formatBytesRaw(d.net.rx)} ‚ñ≤${formatBytesRaw(d.net.tx)}</span></div>
        </div>
      `;

      // Add GPU stats
      fetchGPUStats();
    }

    // --- GPU Stats ---
    let gpuHistory = {}; // gpu index -> history array
    let gpuInitialized = false;

    // Toggle GPU panel collapse
    function toggleGPUPanel() {
      const panel = document.getElementById('gpu-panel');
      const isCollapsed = panel.classList.toggle('collapsed');
      localStorage.setItem('gpuPanelCollapsed', isCollapsed);
    }

    async function fetchGPUStats() {
      try {
        const response = await fetch('/api/gpu/stats');
        if (!response.ok) return;

        const data = await response.json();

        if (data.gpus && data.gpus.length > 0) {
          if (!gpuInitialized) {
            initGPUPanel(data.gpus);
            gpuInitialized = true;
          } else {
            updateGPUStats(data.gpus);
          }
        }
      } catch (err) {
        console.error('Failed to fetch GPU stats:', err);
      }
    }

    function initGPUPanel(gpus) {
      const panel = document.getElementById('gpu-panel');
      const count = document.getElementById('gpu-count');
      const grid = document.getElementById('gpu-grid');

      // Show panel and set count
      panel.style.display = 'block';
      count.textContent = `${gpus.length} GPU${gpus.length > 1 ? 's' : ''}`;

      // Restore collapsed state
      const isCollapsed = localStorage.getItem('gpuPanelCollapsed') === 'true';
      if (isCollapsed) {
        panel.classList.add('collapsed');
      }

      // Create GPU cards
      grid.innerHTML = '';
      for (const gpu of gpus) {
        const card = document.createElement('div');
        card.className = 'gpu-card';
        card.id = `gpu-card-${gpu.index}`;

        card.innerHTML = `
          <div class="gpu-card-header">
            <div>
              <div class="gpu-card-vendor">${gpu.vendor} GPU ${gpu.index}</div>
              <div class="gpu-card-name">${gpu.name}</div>
            </div>
          </div>
          <div class="gpu-metrics">
            <div class="gpu-metric">
              <div class="gpu-metric-label">
                <span>GPU Utilization</span>
                <span class="gpu-metric-value" id="gpu-${gpu.index}-util-value">0%</span>
              </div>
              <div class="gpu-metric-bar">
                <div class="gpu-metric-bar-fill" id="gpu-${gpu.index}-util-bar" style="width: 0%;"></div>
              </div>
            </div>
            <div class="gpu-metric">
              <div class="gpu-metric-label">
                <span>Memory</span>
                <span class="gpu-metric-value" id="gpu-${gpu.index}-mem-value">0%</span>
              </div>
              <div class="gpu-metric-bar">
                <div class="gpu-metric-bar-fill" id="gpu-${gpu.index}-mem-bar" style="width: 0%;"></div>
              </div>
              <div class="gpu-metric-subtext" id="gpu-${gpu.index}-mem-text">0 / 0 MiB</div>
            </div>
            <div class="gpu-metric">
              <div class="gpu-metric-label">
                <span>Temperature</span>
                <span class="gpu-metric-value" id="gpu-${gpu.index}-temp-value">0¬∞C</span>
              </div>
              <div class="gpu-metric-bar">
                <div class="gpu-metric-bar-fill" id="gpu-${gpu.index}-temp-bar" style="width: 0%;"></div>
              </div>
            </div>
            <div class="gpu-metric">
              <div class="gpu-metric-label">
                <span>Power Draw</span>
                <span class="gpu-metric-value" id="gpu-${gpu.index}-power-value">0W</span>
              </div>
              <div class="gpu-metric-bar">
                <div class="gpu-metric-bar-fill" id="gpu-${gpu.index}-power-bar" style="width: 0%;"></div>
              </div>
              <div class="gpu-metric-subtext" id="gpu-${gpu.index}-power-text">Limit: 0W</div>
            </div>
          </div>
          ${gpu.note ? `<div class="gpu-metric-subtext" style="margin-top: 4px;">${gpu.note}</div>` : ''}
        `;

        grid.appendChild(card);

        // Initialize history
        gpuHistory[gpu.index] = { util: [], mem: [], temp: [], power: [] };
      }
    }

    function updateGPUStats(gpus) {
      for (const gpu of gpus) {
        const idx = gpu.index;

        // Update history
        if (!gpuHistory[idx]) {
          gpuHistory[idx] = { util: [], mem: [], temp: [], power: [] };
        }

        const hist = gpuHistory[idx];
        hist.util.push(gpu.utilization.gpu);
        hist.mem.push(gpu.utilization.memory);
        hist.temp.push(gpu.temperature);
        hist.power.push(gpu.power.draw);

        // Keep last 20 samples
        if (hist.util.length > 20) {
          hist.util.shift();
          hist.mem.shift();
          hist.temp.shift();
          hist.power.shift();
        }

        // Get color classes
        const tempColor = gpu.temperature > 80 ? 'hot' : gpu.temperature > 65 ? 'warm' : 'cool';
        const utilColor = gpu.utilization.gpu > 80 ? 'hot' : gpu.utilization.gpu > 50 ? 'warm' : 'cool';
        const memColor = gpu.utilization.memory > 85 ? 'hot' : gpu.utilization.memory > 60 ? 'warm' : 'cool';
        const powerColor = (gpu.power.limit > 0 && gpu.power.draw > gpu.power.limit * 0.9) ? 'hot' : 'cool';

        // Update GPU Utilization
        const utilValue = document.getElementById(`gpu-${idx}-util-value`);
        const utilBar = document.getElementById(`gpu-${idx}-util-bar`);
        if (utilValue && utilBar) {
          utilValue.textContent = `${gpu.utilization.gpu.toFixed(0)}%`;
          utilBar.style.width = `${gpu.utilization.gpu}%`;
          utilBar.className = `gpu-metric-bar-fill ${utilColor}`;
        }

        // Update Memory
        const memValue = document.getElementById(`gpu-${idx}-mem-value`);
        const memBar = document.getElementById(`gpu-${idx}-mem-bar`);
        const memText = document.getElementById(`gpu-${idx}-mem-text`);
        if (memValue && memBar && memText) {
          memValue.textContent = `${gpu.utilization.memory.toFixed(0)}%`;
          memBar.style.width = `${gpu.utilization.memory}%`;
          memBar.className = `gpu-metric-bar-fill ${memColor}`;
          memText.textContent = `${gpu.memory.used.toFixed(0)} / ${gpu.memory.total.toFixed(0)} ${gpu.memory.unit}`;
        }

        // Update Temperature
        const tempValue = document.getElementById(`gpu-${idx}-temp-value`);
        const tempBar = document.getElementById(`gpu-${idx}-temp-bar`);
        if (tempValue && tempBar) {
          tempValue.textContent = `${gpu.temperature.toFixed(0)}¬∞C`;
          const tempPercent = Math.min(gpu.temperature, 95) / 95 * 100;
          tempBar.style.width = `${tempPercent}%`;
          tempBar.className = `gpu-metric-bar-fill ${tempColor}`;
        }

        // Update Power
        const powerValue = document.getElementById(`gpu-${idx}-power-value`);
        const powerBar = document.getElementById(`gpu-${idx}-power-bar`);
        const powerText = document.getElementById(`gpu-${idx}-power-text`);
        if (powerValue && powerBar && powerText) {
          powerValue.textContent = `${gpu.power.draw.toFixed(0)}${gpu.power.unit}`;
          const powerPercent = gpu.power.limit > 0 ? (gpu.power.draw / gpu.power.limit * 100) : 0;
          powerBar.style.width = `${powerPercent}%`;
          powerBar.className = `gpu-metric-bar-fill ${powerColor}`;
          powerText.textContent = `Limit: ${gpu.power.limit.toFixed(0)}${gpu.power.unit}`;
        }
      }
    }

    // --- Views ---
    function setView(view) {
      document.getElementById('main-content').dataset.view = view;
      document.querySelectorAll('.view-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.view === view);
      });
      const tc = document.getElementById('terminal-container');
      const pc = document.getElementById('preview-container');
      tc.style.width = '';
      tc.style.height = '';
      tc.style.flex = '';
      pc.style.flex = '';
      updateResizerClass();
      dashboardVisible = (view === 'dashboard');

      // Lazy-load code editor when switching to code view
      if (view === 'code' && currentProjectPath && !codeEditorLoaded) {
        loadCodeEditor(currentProjectPath);
        codeEditorLoaded = true;
      }

      setTimeout(() => { if (fitAddon) fitAddon.fit(); }, 50);
    }

    document.querySelectorAll('.view-tab').forEach(tab => {
      tab.addEventListener('click', () => setView(tab.dataset.view));
    });

    // --- Fullscreen ---
    document.getElementById('btn-fullscreen').addEventListener('click', () => {
      isFullscreen = !isFullscreen;
      document.body.classList.toggle('fullscreen-preview', isFullscreen);
      document.getElementById('btn-fullscreen').innerHTML = isFullscreen ? '&#10005;' : '&#9974;';
    });

    // --- Resizer ---
    function isHorizontalSplit() {
      const main = document.getElementById('main-content');
      return main.dataset.view === 'split' && window.innerWidth > 600;
    }

    function updateResizerClass() {
      const resizer = document.getElementById('resizer');
      resizer.className = 'resizer ' + (isHorizontalSplit() ? 'horizontal' : 'vertical');
    }

    function initResizer() {
      const resizer = document.getElementById('resizer');
      const preview = document.getElementById('preview-container');
      const terminal = document.getElementById('terminal-container');
      let startPos, startTermSize, startPreviewSize;

      updateResizerClass();

      function start(pos) {
        startPos = pos;
        if (isHorizontalSplit()) {
          startTermSize = terminal.offsetWidth;
          startPreviewSize = preview.offsetWidth;
        } else {
          startTermSize = terminal.offsetHeight;
          startPreviewSize = preview.offsetHeight;
        }
      }

      function drag(pos) {
        const delta = pos - startPos;
        if (isHorizontalSplit()) {
          terminal.style.width = Math.max(100, startTermSize + delta) + 'px';
          terminal.style.flex = 'none';
          preview.style.flex = '1';
        } else {
          terminal.style.height = Math.max(60, startTermSize + delta) + 'px';
          terminal.style.flex = 'none';
          preview.style.flex = '1';
        }
      }

      function stop() {
        document.removeEventListener('mousemove', mm);
        document.removeEventListener('mouseup', mu);
        document.removeEventListener('touchmove', tm);
        document.removeEventListener('touchend', tu);
        if (fitAddon) fitAddon.fit();
      }

      function mm(e) { drag(isHorizontalSplit() ? e.clientX : e.clientY); }
      function mu() { stop(); }
      function tm(e) { e.preventDefault(); drag(isHorizontalSplit() ? e.touches[0].clientX : e.touches[0].clientY); }
      function tu() { stop(); }

      resizer.addEventListener('mousedown', e => {
        start(isHorizontalSplit() ? e.clientX : e.clientY);
        document.addEventListener('mousemove', mm);
        document.addEventListener('mouseup', mu);
        e.preventDefault();
      });

      resizer.addEventListener('touchstart', e => {
        start(isHorizontalSplit() ? e.touches[0].clientX : e.touches[0].clientY);
        document.addEventListener('touchmove', tm, { passive: false });
        document.addEventListener('touchend', tu);
        e.preventDefault();
      });
    }

    // --- Virtual Keys ---
    const keyMap = {
      'escape': '\x1b', 'tab': '\t',
      'ctrl-c': '\x03', 'ctrl-d': '\x04', 'ctrl-z': '\x1a',
      'ctrl-l': '\x0c', 'ctrl-a': '\x01', 'ctrl-e': '\x05',
      'up': '\x1b[A', 'down': '\x1b[B', 'left': '\x1b[D', 'right': '\x1b[C',
      'pipe': '|', 'amp': '&', 'tilde': '~', 'dash': '-', 'slash': '/'
    };

    document.getElementById('virtual-keys').addEventListener('click', (e) => {
      const btn = e.target.closest('.vkey');
      if (!btn) return;
      const key = btn.dataset.key;
      if (key === 'ctrl') { ctrlActive = !ctrlActive; btn.classList.toggle('active', ctrlActive); return; }
      if (key === 'copy') { termCopy(); return; }
      if (key === 'paste') { termPaste(); return; }
      const seq = keyMap[key];
      if (seq) sendKey(seq);
      if (ctrlActive) { ctrlActive = false; document.getElementById('vkey-ctrl').classList.remove('active'); }
    });

    async function termCopy() {
      if (!term) return;
      const sel = term.getSelection();
      if (sel) {
        try {
          await navigator.clipboard.writeText(sel);
        } catch {
          // Fallback for older browsers
          const ta = document.createElement('textarea');
          ta.value = sel;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
        }
      }
    }

    async function termPaste() {
      try {
        const text = await navigator.clipboard.readText();
        if (text) sendKey(text);
      } catch {
        // Clipboard API not available
      }
      if (term) term.focus();
    }

    function sendKey(seq) {
      if (ws && ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify({ type: 'data', data: seq }));
      if (term) term.focus();
    }

    // --- Event Listeners ---
    document.getElementById('btn-sessions').addEventListener('click', () => {
      setView('dashboard');
    });

    document.getElementById('sessions-close').addEventListener('click', () => {
      document.getElementById('sessions-modal').classList.remove('open');
    });

    document.getElementById('btn-new-session').addEventListener('click', () => {
      document.getElementById('sessions-modal').classList.remove('open');
      openNewSessionModal();
    });

    document.getElementById('new-session-close').addEventListener('click', () => {
      document.getElementById('new-session-modal').classList.remove('open');
    });

    document.getElementById('new-session-cancel').addEventListener('click', () => {
      document.getElementById('new-session-modal').classList.remove('open');
    });

    document.getElementById('btn-create-session').addEventListener('click', createSession);

    document.getElementById('fb-up').addEventListener('click', () => {
      const parent = fbCurrentPath.split('/').slice(0, -1).join('/') || '/';
      fbBrowse(parent);
    });

    document.getElementById('fb-create').addEventListener('click', fbCreateFolder);
    document.getElementById('fb-new-folder').addEventListener('keydown', e => { if (e.key === 'Enter') fbCreateFolder(); });

    // Source tab switching
    document.querySelectorAll('.source-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        sourceMode = tab.dataset.source;
        document.querySelectorAll('.source-tab').forEach(t => t.classList.toggle('active', t.dataset.source === sourceMode));
        document.getElementById('source-folder').style.display = sourceMode === 'folder' ? 'block' : 'none';
        document.getElementById('source-git').style.display = sourceMode === 'git' ? 'block' : 'none';
      });
    });

    // Tool tab switching
    document.querySelectorAll('.tool-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        selectedTool = tab.dataset.tool;
        document.querySelectorAll('.tool-tab').forEach(t => t.classList.toggle('active', t.dataset.tool === selectedTool));
        const isAI = selectedTool !== 'bash';
        document.getElementById('autonomous-label').style.display = isAI ? 'flex' : 'none';
        document.getElementById('initial-prompt-group').style.display = isAI ? 'block' : 'none';
      });
    });

    // Git URL auto-fill name
    document.getElementById('input-git-url').addEventListener('input', (e) => {
      const nameInput = document.getElementById('input-session-name');
      if (!nameInput.value) {
        const match = e.target.value.match(/\/([^\/]+?)(\.git)?$/);
        if (match) nameInput.value = match[1].replace(/[^a-zA-Z0-9_-]/g, '-');
      }
    });

    // URL bar
    document.getElementById('btn-go-url').addEventListener('click', () => {
      const url = document.getElementById('preview-url-input').value.trim();
      if (url) loadPreviewUrl(url);
    });

    document.getElementById('preview-url-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const url = e.target.value.trim();
        if (url) loadPreviewUrl(url);
      }
    });

    document.getElementById('btn-open-external').addEventListener('click', () => {
      const url = document.getElementById('preview-url-input').value.trim();
      if (url) window.open(url, '_blank');
    });

    document.getElementById('btn-refresh-ports').addEventListener('click', () => {
      // Ports auto-update via status WebSocket
    });
    document.getElementById('btn-refresh-preview').addEventListener('click', () => {
      const iframe = document.getElementById('preview-iframe');
      if (iframe.src) iframe.src = iframe.src;
    });

    // Theme toggle
    function applyTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('pg_theme', theme);
      // Update terminal theme
      if (term) {
        term.options.theme = theme === 'light'
          ? { background: '#f8f8fa', foreground: '#1a1a2e', cursor: '#4f46e5', selectionBackground: 'rgba(79,70,229,0.2)' }
          : { background: '#09090b', foreground: '#ececf1', cursor: '#6366f1', selectionBackground: 'rgba(99,102,241,0.3)' };
      }
    }

    document.getElementById('btn-theme').addEventListener('click', () => {
      const current = document.documentElement.getAttribute('data-theme') || 'dark';
      applyTheme(current === 'dark' ? 'light' : 'dark');
    });

    document.getElementById('notify-toggle').addEventListener('click', () => {
      notifySoundEnabled = !notifySoundEnabled;
      localStorage.setItem('notifySound', notifySoundEnabled);
      updateNotifyIcon();
    });
    updateNotifyIcon();

    // Load saved theme
    const savedTheme = localStorage.getItem('pg_theme') || 'dark';
    if (savedTheme === 'light') applyTheme('light');

    window.addEventListener('resize', () => {
      updateResizerClass();
      // Reset inline resizer styles when orientation changes
      const tc = document.getElementById('terminal-container');
      const pc = document.getElementById('preview-container');
      if (document.getElementById('main-content').dataset.view === 'split') {
        tc.style.width = '';
        tc.style.height = '';
        tc.style.flex = '';
        pc.style.flex = '';
      }
      if (fitAddon) setTimeout(() => fitAddon.fit(), 50);
    });
    // --- Status WebSocket ---
    function connectStatusWs() {
      const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      statusWs = new WebSocket(`${protocol}//${location.host}/status`);

      statusWs.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          if (data.type === 'status') {
            renderPorts(data.ports);
            renderSessionSwitcher(data.sessions);
            renderDashboard(data);
            renderSysmon(data.system);
          } else if (data.type === 'task_progress') {
            updateTaskProgress(data.sessionName, data.data);
          } else if (data.type === 'task_step_complete') {
            updateTaskStep(data.sessionName, data.data);
          } else if (data.type === 'ralph_update') {
            handleRalphUpdate(data.sessionName, data.data);
          } else if (data.type.startsWith('loop_')) {
            // Handle loop events (started, paused, resumed, stopped, complete, stuck, iteration)
            if (currentTasksSession === data.sessionName) {
              refreshTasksModal();
            }
          } else if (data.type === 'task_complete') {
            if (currentTasksSession === data.sessionName) {
              refreshTasksModal();
            }
          }
        } catch {}
      };

      statusWs.onclose = () => {
        // Reconnect after 3s
        setTimeout(connectStatusWs, 3000);
      };

      statusWs.onerror = () => {};
    }

    // --- Init ---
    function init() {
      initTerminal();
      initResizer();
      setView('dashboard');
      connectStatusWs();
      loadMemory(); // Load cross-session memory
    }

    init();
  </script>
</body>
</html>
